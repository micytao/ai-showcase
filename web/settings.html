<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - AI Showcase</title>
    <link rel="icon" type="image/png" href="../assets/ai-showcase.png">
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --rh-red: #EE0000;
            --rh-dark-red: #CC0000;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --bg-tertiary: #e9ecef;
            --bg-hover: rgba(238, 0, 0, 0.05);
            --text-primary: #151515;
            --text-secondary: #4a5568;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #242424;
            --bg-tertiary: #3a3a3a;
            --bg-hover: rgba(238, 0, 0, 0.1);
            --text-primary: #f5f5f5;
            --text-secondary: #b8b8b8;
            --text-muted: #888888;
            --border-color: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Red Hat Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .header h1 i {
            color: var(--rh-red);
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 1.25rem;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--rh-red);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Status Message */
        .settings-status {
            display: none;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            padding-right: 2.5rem;
        }

        .settings-status.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .settings-status.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .settings-status.info {
            display: block;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .settings-status-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            opacity: 0.6;
            padding: 0.25rem;
            line-height: 1;
            font-size: 1rem;
            transition: opacity 0.2s ease;
        }

        .settings-status-close:hover {
            opacity: 1;
        }

        /* Compact Endpoint Cards */
        .endpoint-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .endpoint-card:hover {
            border-color: var(--rh-red);
            box-shadow: var(--shadow-md);
        }

        .endpoint-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .endpoint-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .endpoint-icon {
            color: var(--rh-red);
            font-size: 1.25rem;
        }
        
        .endpoint-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }
        
        .endpoint-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .endpoint-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .endpoint-badge-primary {
            background: linear-gradient(135deg, var(--rh-red), #c00);
            color: white;
        }

        .endpoint-badge-optional {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .endpoint-card-body {
            padding: 1rem;
        }

        .endpoint-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .endpoint-field {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .endpoint-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .endpoint-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.2s ease;
        }

        .endpoint-input:focus {
            outline: none;
            border-color: var(--rh-red);
            box-shadow: 0 0 0 2px rgba(238, 0, 0, 0.1);
        }

        .endpoint-actions {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .endpoint-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
        }

        .endpoint-btn-fetch {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .endpoint-btn-fetch:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
        }

        .endpoint-btn-fetch:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .endpoint-btn-test {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .endpoint-btn-test:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }

        .endpoint-btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Test button states */
        .endpoint-btn-test.not-tested {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .endpoint-btn-test.not-tested:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
        }

        .endpoint-btn-test.test-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .endpoint-btn-test.test-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .endpoint-btn-test.test-failed {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .endpoint-btn-test.test-failed:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        /* Input with Toggle */
        .input-with-toggle {
            position: relative;
            display: flex;
            align-items: center;
        }

        .toggle-btn {
            position: absolute;
            right: 0.375rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.9375rem;
        }

        .toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--rh-red);
        }

        .input-with-toggle .endpoint-input {
            padding-right: 2.5rem;
        }

        /* Input with Unit */
        .input-with-unit {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-unit .endpoint-input {
            padding-right: 3.5rem;
        }

        .input-unit-label {
            position: absolute;
            right: 0.75rem;
            color: var(--text-muted);
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .required-indicator {
            color: var(--rh-red);
            font-weight: 700;
        }

        /* Add Endpoint Section */
        .add-endpoint-section {
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .add-endpoint-btn {
            background: transparent;
            border: none;
            color: var(--rh-red);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }
        
        .add-endpoint-btn:hover {
            background: var(--bg-hover);
        }
        
        .add-endpoint-help {
            display: block;
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.375rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-title i {
            color: var(--rh-red);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--rh-red);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-field {
            margin-bottom: 1.25rem;
        }

        .modal-field:last-child {
            margin-bottom: 0;
        }

        .modal-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.2s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--rh-red);
            box-shadow: 0 0 0 2px rgba(238, 0, 0, 0.1);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-btn-cancel:hover {
            background: var(--bg-hover);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--rh-red), #c00);
            color: white;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #c00, #a00);
            transform: translateY(-1px);
        }

        /* Remove Endpoint Button */
        .endpoint-remove-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .endpoint-remove-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Compact Collapsible Settings */
        .settings-collapsible {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .settings-collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .settings-collapsible-header:hover {
            background: var(--bg-secondary);
        }

        .settings-collapsible-title {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .settings-collapsible-title i {
            color: var(--text-secondary);
            font-size: 1.0625rem;
        }
        
        .settings-collapsible-icon {
            transition: transform 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        .settings-collapsible.expanded .settings-collapsible-icon {
            transform: rotate(180deg);
        }

        .settings-collapsible-body {
            padding: 0 1rem 1rem 1rem;
        }

        /* Action Buttons */
        .settings-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding-top: 1rem;
        }

        .settings-action-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-action-primary {
            background: linear-gradient(135deg, var(--rh-red), #c00);
            color: white;
        }

        .settings-action-primary:hover {
            background: linear-gradient(135deg, #c00, #a00);
            transform: translateY(-1px);
        }

        .settings-action-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .settings-action-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--rh-red);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .endpoint-grid {
                grid-template-columns: 1fr;
            }

            .settings-actions {
                flex-direction: column;
            }

            .settings-action-btn {
                width: 100%;
                justify-content: center;
            }

            .endpoint-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .endpoint-badge {
                align-self: flex-start;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-cog"></i>
                Settings
            </h1>
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>

        <!-- Status Message -->
        <div class="settings-status" id="settingsStatus"></div>

        <!-- Endpoint Configuration Cards Container -->
        <div id="endpointsContainer">
            <!-- VLM Endpoint (Primary) -->
            <div class="endpoint-card" data-endpoint-type="vlm">
                <div class="endpoint-card-header">
                    <div class="endpoint-info">
                        <i class="fas fa-video endpoint-icon"></i>
                        <div>
                            <div class="endpoint-title">Vision Language Model</div>
                            <div class="endpoint-subtitle">Primary model for vision analysis</div>
                        </div>
                    </div>
                    <span class="endpoint-badge endpoint-badge-primary">Required</span>
                </div>
                
                <div class="endpoint-card-body">
                    <div class="endpoint-grid">
                        <div class="endpoint-field">
                            <label class="endpoint-label">Endpoint URL</label>
                            <input 
                                type="text" 
                                id="vlmEndpoint" 
                                class="endpoint-input" 
                                placeholder="http://localhost:8000/v1"
                            >
                        </div>
                        
                        <div class="endpoint-field">
                            <label class="endpoint-label">API Key <span class="required-indicator">*</span></label>
                            <div class="input-with-toggle">
                                <input 
                                    type="password" 
                                    id="vlmApiKey" 
                                    class="endpoint-input" 
                                    placeholder="sk-..."
                                >
                                <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('vlmApiKey')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="endpoint-actions">
                        <button id="fetchVlmModelsBtn" class="endpoint-btn endpoint-btn-fetch" onclick="fetchModels('vlm')">
                            <i class="fas fa-download"></i> Fetch Models
                        </button>
                        <button id="testVlmBtn" class="endpoint-btn endpoint-btn-test not-tested" onclick="testEndpointConnection('vlm')">
                            <i class="fas fa-plug"></i> Test
                        </button>
                        
                        <div class="endpoint-field" id="vlmModelSelectGroup" style="display: none; flex: 1;">
                            <select id="vlmModelSelect" class="endpoint-input">
                                <option value="">-- Select model --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guardrails Endpoint (Optional) -->
            <div class="endpoint-card" data-endpoint-type="guardrails">
                <div class="endpoint-card-header">
                    <div class="endpoint-info">
                        <i class="fas fa-shield-alt endpoint-icon"></i>
                        <div>
                            <div class="endpoint-title">Content Safety Guardrails</div>
                            <div class="endpoint-subtitle">Optional safety filtering</div>
                        </div>
                    </div>
                    <span class="endpoint-badge endpoint-badge-optional">Optional</span>
                </div>
                
                <div class="endpoint-card-body">
                    <div class="endpoint-grid">
                        <div class="endpoint-field">
                            <label class="endpoint-label">Endpoint URL</label>
                            <input 
                                type="text" 
                                id="guardrailsEndpoint" 
                                class="endpoint-input" 
                                placeholder="http://localhost:8001/v1"
                            >
                        </div>
                        
                        <div class="endpoint-field">
                            <label class="endpoint-label">API Key <span class="required-indicator">*</span></label>
                            <div class="input-with-toggle">
                                <input 
                                    type="password" 
                                    id="guardrailsApiKey" 
                                    class="endpoint-input" 
                                    placeholder="sk-..."
                                >
                                <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('guardrailsApiKey')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="endpoint-actions">
                        <button id="fetchGuardrailsModelsBtn" class="endpoint-btn endpoint-btn-fetch" onclick="fetchModels('guardrails')">
                            <i class="fas fa-download"></i> Fetch Models
                        </button>
                        <button id="testGuardrailsBtn" class="endpoint-btn endpoint-btn-test not-tested" onclick="testEndpointConnection('guardrails')">
                            <i class="fas fa-plug"></i> Test
                        </button>
                        
                        <div class="endpoint-field" id="guardrailsModelSelectGroup" style="display: none; flex: 1;">
                            <select id="guardrailsModelSelect" class="endpoint-input">
                                <option value="">-- Select model --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Endpoint Button (for future expansion) -->
        <div class="add-endpoint-section">
            <button class="add-endpoint-btn" onclick="showAddEndpointDialog()">
                <i class="fas fa-plus-circle"></i>
                Add Custom Endpoint
            </button>
            <span class="add-endpoint-help">
                <i class="fas fa-info-circle"></i> Add LLM, Embedding, or other AI model endpoints
            </span>
        </div>

        <!-- Advanced Settings (Compact) -->
        <div class="settings-collapsible">
            <div class="settings-collapsible-header" onclick="toggleAdvancedSettings()">
                <div class="settings-collapsible-title">
                    <i class="fas fa-sliders-h"></i>
                    <span>Advanced Settings</span>
                </div>
                <i class="fas fa-chevron-down settings-collapsible-icon"></i>
            </div>
            
            <div class="settings-collapsible-body" id="advancedSettingsBody" style="display: none;">
                <div class="endpoint-grid">
                    <div class="endpoint-field">
                        <label class="endpoint-label">Request Timeout</label>
                        <div class="input-with-unit">
                            <input 
                                type="number" 
                                id="timeout" 
                                class="endpoint-input" 
                                value="30"
                                min="5"
                                max="300"
                            >
                            <span class="input-unit-label">sec</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="settings-actions">
            <button class="settings-action-btn settings-action-secondary" onclick="resetSettings()">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button class="settings-action-btn settings-action-primary" id="saveSettingsBtn" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <!-- Add Endpoint Modal -->
    <div class="modal-overlay" id="addEndpointModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Add Custom Endpoint
                </h3>
                <button class="modal-close" onclick="closeAddEndpointDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label class="modal-label">Model Name <span class="required-indicator">*</span></label>
                    <input 
                        type="text" 
                        id="customModelName" 
                        class="modal-input" 
                        placeholder="e.g., Custom LLM, Embedding Model"
                    >
                </div>
                <div class="modal-field">
                    <label class="modal-label">Endpoint URL <span class="required-indicator">*</span></label>
                    <input 
                        type="text" 
                        id="customEndpointUrl" 
                        class="modal-input" 
                        placeholder="http://localhost:8000/v1"
                    >
                </div>
                <div class="modal-field">
                    <label class="modal-label">API Key <span class="required-indicator">*</span></label>
                    <input 
                        type="password" 
                        id="customApiKey" 
                        class="modal-input" 
                        placeholder="sk-..."
                    >
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddEndpointDialog()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-primary" onclick="addCustomEndpoint()">
                    <i class="fas fa-plus"></i> Add Endpoint
                </button>
            </div>
        </div>
    </div>

    <script>
        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('#themeToggle i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Notify parent window to update theme
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'theme-changed', theme: newTheme }, '*');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        
        // Listen for theme changes from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'theme-changed') {
                document.documentElement.setAttribute('data-theme', event.data.theme);
                updateThemeIcon(event.data.theme);
            }
        });

        // Settings Functions
        function loadSettings() {
            const vlmEndpoint = localStorage.getItem('vlmEndpoint') || '';
            const guardrailsEndpoint = localStorage.getItem('guardrailsEndpoint') || '';
            const vlmModel = localStorage.getItem('vlmModel') || '';
            const guardrailsModel = localStorage.getItem('guardrailsModel') || '';
            const vlmApiKey = localStorage.getItem('vlmApiKey') || '';
            const guardrailsApiKey = localStorage.getItem('guardrailsApiKey') || '';
            const timeout = localStorage.getItem('timeout') || '30';

            document.getElementById('vlmEndpoint').value = vlmEndpoint;
            document.getElementById('guardrailsEndpoint').value = guardrailsEndpoint;
            document.getElementById('vlmApiKey').value = vlmApiKey;
            document.getElementById('guardrailsApiKey').value = guardrailsApiKey;
            document.getElementById('timeout').value = timeout;

            // Try to restore model selections if models are available
            const vlmModels = localStorage.getItem('vlmModels');
            if (vlmModels) {
                try {
                    const models = JSON.parse(vlmModels);
                    populateModelDropdown('vlm', models, vlmModel);
                } catch (e) {
                    console.error('Error loading VLM models:', e);
                }
            } else if (vlmModel) {
                // Fallback: show saved model even if model list wasn't fetched
                populateModelDropdown('vlm', [vlmModel], vlmModel);
            }

            const guardrailsModels = localStorage.getItem('guardrailsModels');
            if (guardrailsModels) {
                try {
                    const models = JSON.parse(guardrailsModels);
                    populateModelDropdown('guardrails', models, guardrailsModel);
                } catch (e) {
                    console.error('Error loading guardrails models:', e);
                }
            } else if (guardrailsModel) {
                // Fallback: show saved model even if model list wasn't fetched
                populateModelDropdown('guardrails', [guardrailsModel], guardrailsModel);
            }

            // Load custom endpoints settings
            const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
            customEndpoints.forEach(endpoint => {
                const endpointInput = document.getElementById(`${endpoint.id}Endpoint`);
                const apiKeyInput = document.getElementById(`${endpoint.id}ApiKey`);
                const modelSelect = document.getElementById(`${endpoint.id}ModelSelect`);
                
                if (endpointInput) {
                    const savedEndpoint = localStorage.getItem(`${endpoint.id}Endpoint`) || endpoint.endpoint;
                    endpointInput.value = savedEndpoint;
                }
                
                if (apiKeyInput) {
                    const savedApiKey = localStorage.getItem(`${endpoint.id}ApiKey`) || endpoint.apiKey;
                    apiKeyInput.value = savedApiKey;
                }

                // Try to restore model selections
                const savedModel = localStorage.getItem(`${endpoint.id}Model`) || '';
                const savedModels = localStorage.getItem(`${endpoint.id}Models`);
                if (savedModels) {
                    try {
                        const models = JSON.parse(savedModels);
                        populateModelDropdown(endpoint.id, models, savedModel);
                    } catch (e) {
                        console.error(`Error loading ${endpoint.id} models:`, e);
                    }
                } else if (savedModel) {
                    // Fallback: show saved model even if model list wasn't fetched
                    populateModelDropdown(endpoint.id, [savedModel], savedModel);
                }
            });
        }

        function saveSettings() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            
            // Prevent duplicate saves
            if (saveBtn.disabled) {
                return;
            }
            
            const vlmEndpoint = document.getElementById('vlmEndpoint').value.trim();
            const guardrailsEndpoint = document.getElementById('guardrailsEndpoint').value.trim();
            const vlmModel = document.getElementById('vlmModelSelect').value.trim();
            const guardrailsModel = document.getElementById('guardrailsModelSelect').value.trim();
            const vlmApiKey = document.getElementById('vlmApiKey').value.trim();
            const guardrailsApiKey = document.getElementById('guardrailsApiKey').value.trim();
            const timeout = document.getElementById('timeout').value.trim();

            // Validate required fields
            if (!vlmEndpoint) {
                showSettingsStatus('error', '❌ VLM Endpoint URL is required. Please enter a valid endpoint.');
                document.getElementById('vlmEndpoint').focus();
                return;
            }

            if (!vlmApiKey) {
                showSettingsStatus('error', '❌ VLM API Key is required. Please enter a valid API key.');
                document.getElementById('vlmApiKey').focus();
                return;
            }

            // Validate timeout
            const timeoutNum = parseInt(timeout);
            if (isNaN(timeoutNum) || timeoutNum < 5 || timeoutNum > 300) {
                showSettingsStatus('error', '❌ Timeout must be a number between 5 and 300 seconds.');
                document.getElementById('timeout').focus();
                return;
            }

            // Show loading state
            saveBtn.disabled = true;
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Simulate async save (in case we need to add async operations later)
            setTimeout(() => {
                try {
                    localStorage.setItem('vlmEndpoint', vlmEndpoint);
                    localStorage.setItem('guardrailsEndpoint', guardrailsEndpoint);
                    // Only overwrite saved model if a non-empty value is selected
                    if (vlmModel) {
                        localStorage.setItem('vlmModel', vlmModel);
                    }
                    if (guardrailsModel) {
                        localStorage.setItem('guardrailsModel', guardrailsModel);
                    }
                    localStorage.setItem('vlmApiKey', vlmApiKey);
                    localStorage.setItem('guardrailsApiKey', guardrailsApiKey);
                    localStorage.setItem('timeout', timeout);

                    // Save custom endpoints settings
                    const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
                    customEndpoints.forEach(endpoint => {
                        const endpointInput = document.getElementById(`${endpoint.id}Endpoint`);
                        const apiKeyInput = document.getElementById(`${endpoint.id}ApiKey`);
                        const modelSelect = document.getElementById(`${endpoint.id}ModelSelect`);
                        
                        if (endpointInput) {
                            localStorage.setItem(`${endpoint.id}Endpoint`, endpointInput.value.trim());
                            // Update the endpoint object in customEndpoints array
                            endpoint.endpoint = endpointInput.value.trim();
                        }
                        
                        if (apiKeyInput) {
                            localStorage.setItem(`${endpoint.id}ApiKey`, apiKeyInput.value.trim());
                            // Update the endpoint object in customEndpoints array
                            endpoint.apiKey = apiKeyInput.value.trim();
                        }
                        
                        if (modelSelect) {
                            const selected = modelSelect.value.trim();
                            if (selected) {
                                localStorage.setItem(`${endpoint.id}Model`, selected);
                            }
                        }
                    });

                    // Update customEndpoints in localStorage with updated values
                    localStorage.setItem('customEndpoints', JSON.stringify(customEndpoints));

                    showSettingsStatus('success', '✅ Settings saved successfully!');

                    // Notify parent window if opened in popup
                    if (window.opener) {
                        window.opener.postMessage({ type: 'settings-updated' }, '*');
                    }

                    setTimeout(() => {
                        hideSettingsStatus();
                    }, 3000);
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showSettingsStatus('error', '❌ Failed to save settings: ' + error.message);
                } finally {
                    // Restore button state
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalHTML;
                }
            }, 100);
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This will also remove all custom endpoints.')) {
                localStorage.removeItem('vlmEndpoint');
                localStorage.removeItem('guardrailsEndpoint');
                localStorage.removeItem('vlmModel');
                localStorage.removeItem('guardrailsModel');
                localStorage.removeItem('vlmApiKey');
                localStorage.removeItem('guardrailsApiKey');
                localStorage.removeItem('timeout');
                localStorage.removeItem('vlmModels');
                localStorage.removeItem('guardrailsModels');

                // Reset all test buttons to not-tested state (yellow)
                document.querySelectorAll('.endpoint-btn-test').forEach(btn => {
                    btn.classList.remove('test-success', 'test-failed');
                    btn.classList.add('not-tested');
                    btn.innerHTML = '<i class="fas fa-plug"></i> Test';
                });

                // Hide model selection dropdowns
                document.getElementById('vlmModelSelectGroup').style.display = 'none';
                document.getElementById('guardrailsModelSelectGroup').style.display = 'none';

                // Remove all custom endpoints
                const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
                customEndpoints.forEach(endpoint => {
                    localStorage.removeItem(`${endpoint.id}Endpoint`);
                    localStorage.removeItem(`${endpoint.id}ApiKey`);
                    localStorage.removeItem(`${endpoint.id}Model`);
                    localStorage.removeItem(`${endpoint.id}Models`);
                    
                    // Remove the card from DOM
                    const card = document.querySelector(`[data-endpoint-type="${endpoint.id}"]`);
                    if (card) {
                        card.remove();
                    }
                });
                localStorage.removeItem('customEndpoints');

                // Reload defaults
                loadSettings();

                showSettingsStatus('success', 'Settings reset to defaults.');
            }
        }

        async function testEndpointConnection(endpointType) {
            // Support both built-in and custom endpoints
            let endpointId, apiKeyId, modelSelectId, testBtnId, typeName;
            
            if (endpointType === 'vlm') {
                endpointId = 'vlmEndpoint';
                apiKeyId = 'vlmApiKey';
                modelSelectId = 'vlmModelSelect';
                testBtnId = 'testVlmBtn';
                typeName = 'VLM';
            } else if (endpointType === 'guardrails') {
                endpointId = 'guardrailsEndpoint';
                apiKeyId = 'guardrailsApiKey';
                modelSelectId = 'guardrailsModelSelect';
                testBtnId = 'testGuardrailsBtn';
                typeName = 'Guardrails';
            } else {
                // Custom endpoint
                endpointId = `${endpointType}Endpoint`;
                apiKeyId = `${endpointType}ApiKey`;
                modelSelectId = `${endpointType}ModelSelect`;
                testBtnId = `test${endpointType}Btn`;
                
                // Get the name from customEndpoints
                const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
                const customEndpoint = customEndpoints.find(ep => ep.id === endpointType);
                typeName = customEndpoint ? customEndpoint.name : 'Custom Endpoint';
            }
            
            const endpoint = document.getElementById(endpointId).value.trim();
            const apiKey = document.getElementById(apiKeyId).value.trim();
            const model = document.getElementById(modelSelectId).value.trim();
            
            // Get the test button for visual feedback
            const testBtn = document.getElementById(testBtnId);
            
            if (!endpoint) {
                showSettingsStatus('error', `Please enter a ${typeName} endpoint to test.`);
                return;
            }

            if (!apiKey) {
                showSettingsStatus('error', `${typeName} API Key is required to test the connection.`);
                return;
            }

            // Remove all status classes and add testing state
            if (testBtn) {
                testBtn.classList.remove('not-tested', 'test-success', 'test-failed');
                testBtn.disabled = true;
                const originalHTML = testBtn.innerHTML;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            }

            showSettingsStatus('info', `Testing ${typeName} connection...`);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                console.log(`Testing ${typeName} connection to:`, endpoint);
                
                // Determine default model based on endpoint type
                let selectedModel;
                if (model) {
                    selectedModel = model;
                } else if (endpointType === 'vlm') {
                    selectedModel = 'Qwen/Qwen2-VL-2B-Instruct';
                } else if (endpointType === 'guardrails') {
                    selectedModel = 'meta-llama/Llama-Guard-3-8B';
                } else {
                    // For custom endpoints, use a generic model if none selected
                    selectedModel = 'default-model';
                }
                console.log('Using model:', selectedModel);
                
                let normalizedEndpoint = endpoint.replace(/\/$/, '');
                
                let apiUrl;
                if (normalizedEndpoint.endsWith('/v1')) {
                    apiUrl = `${normalizedEndpoint}/chat/completions`;
                } else {
                    apiUrl = `${normalizedEndpoint}/v1/chat/completions`;
                }
                
                const testPayload = {
                    model: selectedModel,
                    max_tokens: 20,
                    messages: [
                        { role: "user", content: "Hello, can you respond?" }
                    ]
                };

                console.log('Testing endpoint:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    mode: 'cors',
                    signal: controller.signal,
                    body: JSON.stringify(testPayload)
                });

                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    const testResponse = data.choices?.[0]?.message?.content || 'API responded correctly';
                    console.log('Test response:', testResponse);
                    
                    // Set button to success state (green)
                    if (testBtn) {
                        testBtn.classList.add('test-success');
                        testBtn.disabled = false;
                        testBtn.innerHTML = '<i class="fas fa-check-circle"></i> Test';
                        console.log('✅ Test successful - button set to green:', endpointType);
                    }

                    // Persist the model used for a successful test and reflect it in the UI
                    try {
                        // Save model to localStorage under the appropriate key
                        if (endpointType === 'vlm') {
                            localStorage.setItem('vlmModel', selectedModel);
                        } else if (endpointType === 'guardrails') {
                            localStorage.setItem('guardrailsModel', selectedModel);
                        } else {
                            localStorage.setItem(`${endpointType}Model`, selectedModel);
                        }

                        // Update/select the dropdown with this model and ensure it's visible
                        const modelSelect = document.getElementById(modelSelectId);
                        const groupId = (endpointType === 'vlm')
                            ? 'vlmModelSelectGroup'
                            : (endpointType === 'guardrails')
                                ? 'guardrailsModelSelectGroup'
                                : `${endpointType}ModelSelectGroup`;
                        const selectGroup = document.getElementById(groupId);

                        if (modelSelect) {
                            let hasOption = Array.from(modelSelect.options).some(opt => opt.value === selectedModel);
                            if (!hasOption) {
                                const option = document.createElement('option');
                                option.value = selectedModel;
                                option.textContent = selectedModel;
                                modelSelect.appendChild(option);
                            }
                            modelSelect.value = selectedModel;
                        }
                        if (selectGroup) {
                            selectGroup.style.display = 'flex';
                        }
                    } catch (persistError) {
                        console.warn('Could not persist selected model after successful test:', persistError);
                    }
                    
                    const message = `
                        <strong>✅ ${typeName} Connection Successful!</strong><br><br>
                        <strong>Endpoint:</strong> ${escapeHtml(endpoint)}<br>
                        <strong>Model:</strong> ${escapeHtml(selectedModel)}<br>
                        <strong>Test Response:</strong> ${escapeHtml(testResponse.substring(0, 100))}${testResponse.length > 100 ? '...' : ''}<br><br>
                        <em>You can now save your settings.</em>
                    `;
                    showSettingsStatus('success', message);
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    const shortError = errorText.substring(0, 150);
                    
                    // Set button to failed state (red)
                    if (testBtn) {
                        testBtn.classList.add('test-failed');
                        testBtn.disabled = false;
                        testBtn.innerHTML = '<i class="fas fa-times-circle"></i> Test';
                        console.log('❌ Test failed - button set to red:', endpointType);
                    }
                    
                    const message = `
                        <strong>⚠️ ${typeName} Connection Warning</strong><br><br>
                        <strong>Status:</strong> Server returned error ${response.status}<br>
                        <strong>Endpoint:</strong> ${escapeHtml(endpoint)}<br>
                        <strong>Error:</strong> ${escapeHtml(shortError)}${errorText.length > 150 ? '...' : ''}<br><br>
                        <em>Please check your model selection and API key.</em>
                    `;
                    showSettingsStatus('error', message);
                }
            } catch (error) {
                console.error(`${typeName} connection test error:`, error);
                
                // Set button to failed state (red)
                if (testBtn) {
                    testBtn.classList.add('test-failed');
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fas fa-times-circle"></i> Test';
                    console.log('❌ Test error - button set to red:', endpointType);
                }
                
                let message = '';
                if (error.name === 'AbortError') {
                    message = `
                        <strong>❌ ${typeName} Connection Timeout</strong><br><br>
                        <strong>Endpoint:</strong> ${escapeHtml(endpoint)}<br>
                        <strong>Error:</strong> Connection timed out after 15 seconds<br><br>
                        <strong>Please check:</strong><br>
                        • Is the ${typeName} server running?<br>
                        • Is the URL correct?<br>
                        • Are there any network issues?
                    `;
                } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    message = `
                        <strong>❌ CORS or Connection Error</strong><br><br>
                        <strong>Endpoint:</strong> ${escapeHtml(endpoint)}<br>
                        <strong>Error:</strong> ${escapeHtml(error.message)}<br><br>
                        <strong>For vLLM servers:</strong><br>
                        • Start server with --host 0.0.0.0<br>
                        • Check CORS is properly configured<br>
                        • Ensure the server is accessible
                    `;
                } else {
                    message = `
                        <strong>❌ Connection Failed</strong><br><br>
                        <strong>Endpoint:</strong> ${escapeHtml(endpoint)}<br>
                        <strong>Error:</strong> ${escapeHtml(error.message)}
                    `;
                }
                showSettingsStatus('error', message);
            }
        }

        async function fetchModels(type) {
            // Support both built-in and custom endpoints
            let endpointId, apiKeyId, btnId, selectId, typeName;
            
            if (type === 'vlm') {
                endpointId = 'vlmEndpoint';
                apiKeyId = 'vlmApiKey';
                btnId = 'fetchVlmModelsBtn';
                selectId = 'vlmModelSelect';
                typeName = 'VLM';
            } else if (type === 'guardrails') {
                endpointId = 'guardrailsEndpoint';
                apiKeyId = 'guardrailsApiKey';
                btnId = 'fetchGuardrailsModelsBtn';
                selectId = 'guardrailsModelSelect';
                typeName = 'Guardrails';
            } else {
                // Custom endpoint
                endpointId = `${type}Endpoint`;
                apiKeyId = `${type}ApiKey`;
                btnId = `fetch${type}ModelsBtn`;
                selectId = `${type}ModelSelect`;
                
                // Get the name from customEndpoints
                const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
                const customEndpoint = customEndpoints.find(ep => ep.id === type);
                typeName = customEndpoint ? customEndpoint.name : 'Custom Endpoint';
            }
            
            let endpoint = document.getElementById(endpointId).value.trim();
            const apiKey = document.getElementById(apiKeyId).value.trim();
            const fetchBtn = document.getElementById(btnId);
            const modelSelect = document.getElementById(selectId);
            
            if (!endpoint) {
                showSettingsStatus('error', `Please enter a ${typeName} endpoint first.`);
                return;
            }

            if (!apiKey) {
                showSettingsStatus('error', `${typeName} API Key is required to fetch models. Please enter the API key first.`);
                return;
            }

            endpoint = endpoint.replace(/\/$/, '');

            let modelsUrl;
            if (endpoint.endsWith('/v1')) {
                modelsUrl = `${endpoint}/models`;
            } else {
                modelsUrl = `${endpoint}/v1/models`;
            }

            console.log(`Fetching models from: ${modelsUrl}`);
            
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';
            modelSelect.disabled = true;
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            
            showSettingsStatus('info', `Fetching available models from ${typeName} endpoint...`);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };

                const response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error fetching models:', response.status, errorText);
                    if (response.status === 401) {
                        throw new Error(`Authentication failed. Please check your ${typeName} API key.`);
                    } else if (response.status === 403) {
                        throw new Error(`Access forbidden. Please verify your ${typeName} API key permissions.`);
                    } else if (response.status === 404) {
                        throw new Error(`Endpoint not found. Tried: ${modelsUrl}\n\nPlease verify:\n1. The endpoint URL is correct\n2. The endpoint supports OpenAI-compatible /v1/models API\n3. The service is running and accessible`);
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
                }

                const data = await response.json();
                console.log('Models response:', data);
                
                const models = data.data || data.models || [];
                
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                    showSettingsStatus('error', 'No models found at this endpoint.');
                    return;
                }

                // Store models with appropriate key
                const storageKey = (type === 'vlm' || type === 'guardrails') 
                    ? (type === 'vlm' ? 'vlmModels' : 'guardrailsModels')
                    : `${type}Models`;
                localStorage.setItem(storageKey, JSON.stringify(models));

                populateModelDropdown(type, models);
                modelSelect.disabled = false;

                showSettingsStatus('success', `Successfully fetched ${models.length} model(s)!`);
            } catch (error) {
                console.error('Error fetching models:', error);
                modelSelect.innerHTML = '<option value="">Error - fetch models again</option>';
                
                if (error.name === 'AbortError') {
                    showSettingsStatus('error', 'Request timed out after 10 seconds. Please check your endpoint URL.');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    showSettingsStatus('error', 'CORS or connection error. Make sure the endpoint allows cross-origin requests.');
                } else {
                    showSettingsStatus('error', `Failed to fetch models: ${error.message}`);
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = `<i class="fas fa-download"></i> Fetch Models`;
            }
        }

        function populateModelDropdown(type, models, selectedModel = '') {
            // Support both built-in and custom endpoints
            let selectId, groupId;
            
            if (type === 'vlm') {
                selectId = 'vlmModelSelect';
                groupId = 'vlmModelSelectGroup';
            } else if (type === 'guardrails') {
                selectId = 'guardrailsModelSelect';
                groupId = 'guardrailsModelSelectGroup';
            } else {
                // Custom endpoint
                selectId = `${type}ModelSelect`;
                groupId = `${type}ModelSelectGroup`;
            }
            
            const modelSelect = document.getElementById(selectId);
            const selectGroup = document.getElementById(groupId);
            
            if (!modelSelect || !selectGroup) {
                console.error(`Could not find elements for ${type}: ${selectId}, ${groupId}`);
                return;
            }
            
            modelSelect.innerHTML = '<option value="">-- Select a model --</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                const modelId = model.id || model.name || model;
                option.value = modelId;
                option.textContent = modelId;
                if (modelId === selectedModel) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            
            selectGroup.style.display = 'flex';
        }

        function showSettingsStatus(type, message) {
            const status = document.getElementById('settingsStatus');
            status.className = 'settings-status ' + type;
            status.innerHTML = `
                ${message}
                <button class="settings-status-close" onclick="hideSettingsStatus()" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Scroll to status message
            status.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideSettingsStatus() {
            const status = document.getElementById('settingsStatus');
            status.className = 'settings-status';
            status.innerHTML = '';
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentElement.querySelector('.toggle-btn');
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function toggleAdvancedSettings() {
            const body = document.getElementById('advancedSettingsBody');
            const collapsible = body.closest('.settings-collapsible');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                collapsible.classList.add('expanded');
            } else {
                body.style.display = 'none';
                collapsible.classList.remove('expanded');
            }
        }

        function showAddEndpointDialog() {
            const modal = document.getElementById('addEndpointModal');
            modal.classList.add('active');
            
            // Clear previous inputs
            document.getElementById('customModelName').value = '';
            document.getElementById('customEndpointUrl').value = '';
            document.getElementById('customApiKey').value = '';
        }

        function closeAddEndpointDialog() {
            const modal = document.getElementById('addEndpointModal');
            modal.classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('addEndpointModal');
            if (event.target === modal) {
                closeAddEndpointDialog();
            }
        });

        // Close modal when pressing ESC key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('addEndpointModal');
                if (modal.classList.contains('active')) {
                    closeAddEndpointDialog();
                }
            }
        });

        function addCustomEndpoint() {
            const modelName = document.getElementById('customModelName').value.trim();
            const endpointUrl = document.getElementById('customEndpointUrl').value.trim();
            const apiKey = document.getElementById('customApiKey').value.trim();

            // Validation
            if (!modelName) {
                showSettingsStatus('error', 'Please enter a model name.');
                return;
            }

            if (!endpointUrl) {
                showSettingsStatus('error', 'Please enter an endpoint URL.');
                return;
            }

            if (!apiKey) {
                showSettingsStatus('error', 'Please enter an API key.');
                return;
            }

            // Create unique ID for this endpoint
            const endpointId = 'custom_' + (crypto.randomUUID ? crypto.randomUUID().replace(/-/g, '') : Date.now());

            // Create endpoint object
            const customEndpoint = {
                id: endpointId,
                name: modelName,
                endpoint: endpointUrl,
                apiKey: apiKey
            };

            // Save to localStorage
            let customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
            customEndpoints.push(customEndpoint);
            localStorage.setItem('customEndpoints', JSON.stringify(customEndpoints));

            // Create the endpoint card
            createCustomEndpointCard(customEndpoint);

            // Close modal
            closeAddEndpointDialog();

            showSettingsStatus('success', `Custom endpoint "${modelName}" added successfully!`);
        }

        function createCustomEndpointCard(endpoint) {
            const container = document.getElementById('endpointsContainer');
            
            const card = document.createElement('div');
            card.className = 'endpoint-card';
            card.setAttribute('data-endpoint-type', endpoint.id);
            
            card.innerHTML = `
                <div class="endpoint-card-header">
                    <div class="endpoint-info">
                        <i class="fas fa-microchip endpoint-icon"></i>
                        <div>
                            <div class="endpoint-title">${escapeHtml(endpoint.name)}</div>
                            <div class="endpoint-subtitle">Custom endpoint</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="endpoint-badge endpoint-badge-optional">Custom</span>
                        <button class="endpoint-remove-btn" onclick="removeCustomEndpoint('${endpoint.id}')" title="Remove endpoint">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="endpoint-card-body">
                    <div class="endpoint-grid">
                        <div class="endpoint-field">
                            <label class="endpoint-label">Endpoint URL</label>
                            <input 
                                type="text" 
                                id="${endpoint.id}Endpoint" 
                                class="endpoint-input" 
                                placeholder="http://localhost:8000/v1"
                                value="${escapeHtml(endpoint.endpoint)}"
                            >
                        </div>
                        
                        <div class="endpoint-field">
                            <label class="endpoint-label">API Key <span class="required-indicator">*</span></label>
                            <div class="input-with-toggle">
                                <input 
                                    type="password" 
                                    id="${endpoint.id}ApiKey" 
                                    class="endpoint-input" 
                                    placeholder="sk-..."
                                    value="${escapeHtml(endpoint.apiKey)}"
                                >
                                <button type="button" class="toggle-btn" onclick="togglePasswordVisibility('${endpoint.id}ApiKey')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="endpoint-actions">
                        <button id="fetch${endpoint.id}ModelsBtn" class="endpoint-btn endpoint-btn-fetch" onclick="fetchModels('${endpoint.id}')">
                            <i class="fas fa-download"></i> Fetch Models
                        </button>
                        <button id="test${endpoint.id}Btn" class="endpoint-btn endpoint-btn-test not-tested" onclick="testEndpointConnection('${endpoint.id}')">
                            <i class="fas fa-plug"></i> Test
                        </button>
                        
                        <div class="endpoint-field" id="${endpoint.id}ModelSelectGroup" style="display: none; flex: 1;">
                            <select id="${endpoint.id}ModelSelect" class="endpoint-input">
                                <option value="">-- Select model --</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }

        function removeCustomEndpoint(endpointId) {
            if (!confirm('Are you sure you want to remove this custom endpoint?')) {
                return;
            }

            // Remove from localStorage
            let customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
            customEndpoints = customEndpoints.filter(ep => ep.id !== endpointId);
            localStorage.setItem('customEndpoints', JSON.stringify(customEndpoints));

            // Remove associated data
            localStorage.removeItem(`${endpointId}Endpoint`);
            localStorage.removeItem(`${endpointId}ApiKey`);
            localStorage.removeItem(`${endpointId}Model`);
            localStorage.removeItem(`${endpointId}Models`);

            // Remove the card from DOM
            const card = document.querySelector(`[data-endpoint-type="${endpointId}"]`);
            if (card) {
                card.remove();
            }

            showSettingsStatus('success', 'Custom endpoint removed successfully!');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadCustomEndpoints() {
            const customEndpoints = JSON.parse(localStorage.getItem('customEndpoints') || '[]');
            customEndpoints.forEach(endpoint => {
                createCustomEndpointCard(endpoint);
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadCustomEndpoints();
            loadSettings();
        });
    </script>
</body>
</html>

