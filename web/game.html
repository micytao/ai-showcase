<!DOCTYPE html>
<html lang="en">
<!--
    RED HAT FAMILY DAY 2025! ðŸŽ‰
    
    This version is configured to work with AI Inference Server (vLLM)
    running on OpenShift in a different namespace.
    
    vLLM Configuration:
    - Model: Qwen/Qwen2-VL-2B-Instruct
    - Default port: 8000
    - API endpoint: /v1/chat/completions (OpenAI-compatible)
    - Deployment: Cross-namespace service on OpenShift
    
    Usage:
    1. Deploy this app on OpenShift
    2. Configure route/ingress to proxy /v1/* requests to vLLM service
    3. Click "OpenShift Proxy" button to use relative path (recommended)
    4. Or manually enter vLLM service URL for testing
    
    Test function included to verify vLLM connectivity before running the game.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ‰ Red Hat Family Day 2025 - AI Vision Quest! ðŸŽ®</title>
    <link rel="icon" type="image/png" href="../assets/ai-showcase.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fredoka:wght@300;400;500;600;700&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Fun, vibrant colors for kids! */
            --primary-color: #ff6b9d;
            --primary-hover: #ff4d84;
            --secondary-color: #c7f0ff;
            --success-color: #4ade80;
            --success-hover: #22c55e;
            --danger-color: #ff6b6b;
            --danger-hover: #ff5252;
            --warning-color: #fbbf24;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --bg-primary: #ffffff;
            --bg-secondary: #fef3f9;
            --bg-tertiary: #e0f2fe;
            --border-color: #ffc9e0;
            --border-focus: #ff6b9d;
            --accent-purple: #c084fc;
            --accent-blue: #60a5fa;
            --accent-yellow: #fcd34d;
            --accent-green: #4ade80;
            --shadow-sm: 0 1px 2px 0 rgb(255 107 157 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(255 107 157 / 0.2), 0 2px 4px -2px rgb(255 107 157 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(255 107 157 / 0.2), 0 4px 6px -4px rgb(255 107 157 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(255 107 157 / 0.3), 0 8px 10px -6px rgb(255 107 157 / 0.2);
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.25rem;
            --radius-xl: 1.5rem;
        }

        [data-theme="dark"] {
            --primary-color: #818cf8;
            --primary-hover: #6366f1;
            --secondary-color: #374151;
            --success-color: #34d399;
            --success-hover: #10b981;
            --danger-color: #f87171;
            --danger-hover: #ef4444;
            --warning-color: #fbbf24;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --border-color: #4b5563;
            --border-focus: #818cf8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', 'Comic Neue', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #fef3f9 0%, #e0f2fe 50%, #fef9c3 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Fun animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(96, 165, 250, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(192, 132, 252, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 0.75rem 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Compact container for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .container {
                padding: 0 0.5rem 0.5rem;
                gap: 0.4rem;
            }
        }
        
        /* iPad Split-Screen Layout - Optimized for Landscape */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Landscape optimization - equal split for iPad */
        @media (orientation: landscape) and (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Compact grid gap for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .main-content {
                gap: 0.5rem;
            }
        }
        
        /* Portrait/narrow screen layout - only for small screens or portrait */
        @media (max-width: 767px) and (orientation: portrait) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 250px;
            }
            
            .challenges-panel {
                max-height: none;
            }
        }
        
        @media (orientation: portrait) and (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 300px;
            }
        }
        
        /* Left panel: Game area */
        .game-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Right panel: Challenges (always visible) */
        .challenges-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            min-height: 0;
        }
        
        /* Compact panel spacing for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .challenges-panel {
                gap: 0.5rem;
            }
        }
        
        /* Leaderboard toggle button */
        .floating-leaderboard-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
            border: 3px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .floating-leaderboard-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.5);
        }
        
        .floating-leaderboard-btn:active {
            transform: scale(0.95);
        }
        
        /* Leaderboard Modal */
        .leaderboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            animation: fadeIn 0.2s ease-out;
            padding: 1rem;
        }
        
        .leaderboard-modal.active {
            display: flex;
        }
        
        .leaderboard-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 3px solid var(--border-color);
            animation: modalPop 0.3s ease-out;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .leaderboard-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .leaderboard-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .close-leaderboard-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 1.25rem;
        }
        
        .close-leaderboard-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .redhat-text {
                font-size: 1.5rem;
            }
            
            .fedora-icon {
                width: 45px;
                height: 45px;
            }
        }
        
        @media (max-width: 640px) {
            .redhat-text {
                font-size: 1.25rem;
            }
            
            .fedora-icon {
                width: 35px;
                height: 35px;
            }
            
            .party-emoji {
                font-size: 2rem;
            }
            
            .deco-emoji {
                font-size: 1rem;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .redhat-title {
                gap: 0.5rem;
                flex-wrap: wrap;
                text-align: center;
            }
            
            .header {
                padding: 1rem;
            }
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-primary);
            padding: 0.4rem 0.75rem;
            margin: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        
        /* More compact header in landscape for horizontal iPad */
        @media (orientation: landscape) {
            .header {
                padding: 0.3rem 0.6rem;
            }
        }
        
        /* Extra compact header for iPad Air */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .header {
                padding: 0.3rem 0.5rem;
            }
            
            .redhat-text {
                font-size: 1.5rem;
            }
            
            .fedora-icon {
                width: 40px;
                height: 40px;
            }
            
            .party-emoji {
                font-size: 1.5rem;
            }
        }

        /* Birthday Branding */
        .redhat-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .fedora-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            filter: drop-shadow(0 4px 8px rgba(255, 107, 157, 0.6));
            animation: fedoraBounce 2s ease-in-out infinite;
        }
        
        @media (max-width: 1200px) {
            .fedora-icon {
                width: 50px;
                height: 50px;
            }
        }
        
        @keyframes fedoraBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(-5deg); }
        }
        
        .redhat-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff6b9d;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
            text-shadow: 
                3px 3px 0px #FFFFFF,
                4px 4px 0px #000000,
                0 0 30px rgba(255, 107, 157, 0.6);
            letter-spacing: 0.03em;
            transform: rotate(-2deg);
            animation: cartoonBounce 2s ease-in-out infinite;
        }
        
        /* Responsive title sizing */
        @media (max-width: 1200px) {
            .redhat-text {
                font-size: 2rem;
            }
        }
        
        @keyframes cartoonBounce {
            0%, 100% { transform: rotate(-2deg) translateY(0); }
            50% { transform: rotate(2deg) translateY(-5px); }
        }
        
        @keyframes redhatShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Party Emoji Decorations */
        .party-emoji {
            font-size: 2.5rem;
            animation: partyBounce 1s ease-in-out infinite;
            display: inline-block;
        }
        
        @media (max-width: 1200px) {
            .party-emoji {
                font-size: 2rem;
            }
        }
        
        .party-emoji-2 {
            animation: partyBounce 1s ease-in-out infinite 0.5s;
        }
        
        @keyframes partyBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(15deg); }
        }
        
        /* Floating emoji decorations */
        .emoji-decorations {
            position: relative;
            width: 100%;
            height: 30px;
            text-align: center;
        }
        
        .deco-emoji {
            font-size: 1.5rem;
            position: absolute;
            animation: float 3s ease-in-out infinite;
            opacity: 0.9;
        }
        
        .deco-1 {
            left: 10%;
            animation-delay: 0s;
        }
        
        .deco-2 {
            left: 25%;
            animation-delay: 0.5s;
        }
        
        .deco-3 {
            left: 50%;
            transform: translateX(-50%);
            animation-delay: 1s;
        }
        
        .deco-4 {
            right: 25%;
            animation-delay: 1.5s;
        }
        
        .deco-5 {
            right: 10%;
            animation-delay: 2s;
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 0.9;
            }
            50% { 
                transform: translateY(-10px) rotate(10deg); 
                opacity: 1;
            }
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b9d, #c084fc, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: rainbowShift 3s ease-in-out infinite;
            position: absolute;
            left: 0;
            letter-spacing: 0.5px;
        }
        
        .header h1 i {
            font-size: 1.75rem;
        }
        
        /* Compact title for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .header h1 {
                font-size: 1.2rem;
                gap: 0.4rem;
                display: flex;
            }
            
            .header h1 i {
                font-size: 1rem;
            }
        }
        
        /* Hide title on very small screens */
        @media (max-width: 767px) {
            .header h1 {
                display: none;
            }
        }
        
        @keyframes rainbowShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(20deg); }
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 1.25rem;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .video-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        
        /* Ensure video section fills space in landscape */
        @media (orientation: landscape) {
            .video-section {
                flex: 1 1 auto;
                height: 100%;
            }
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
            background: #000;
            object-fit: cover;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            aspect-ratio: 16 / 9;
        }

        #videoFeed:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        /* Optimize for horizontal iPad viewing */
        @media (orientation: landscape) {
            #videoFeed {
                aspect-ratio: 16 / 9;
                max-height: none;
            }
        }
        
        @media (orientation: portrait) {
            #videoFeed {
                aspect-ratio: 4 / 3;
            }
        }
        
        /* Flip Camera Button */
        .flip-camera-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--primary-color);
            transition: all 0.3s ease;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        .flip-camera-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1) rotate(180deg);
            box-shadow: var(--shadow-xl);
        }
        
        .flip-camera-btn:active {
            transform: scale(0.95) rotate(180deg);
        }
        
        [data-theme="dark"] .flip-camera-btn {
            background: rgba(31, 41, 55, 0.95);
            color: var(--primary-color);
        }
        
        [data-theme="dark"] .flip-camera-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .controls-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.2s ease-out;
            padding: 1rem;
        }
        
        .settings-modal.active {
            display: flex;
        }
        
        .settings-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 3px solid var(--border-color);
            animation: modalPop 0.3s ease-out;
        }
        
        .settings-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-tab {
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.85rem 1.25rem;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            bottom: -2px;
        }
        
        .settings-tab:hover {
            color: var(--primary-color);
            background: var(--bg-secondary);
        }
        
        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tab-content {
            display: none;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        .close-settings-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 1.25rem;
        }
        
        .close-settings-btn:hover {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        select, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all 0.3s ease;
            appearance: none;
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
            background: var(--bg-primary);
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        /* Compact buttons for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
                gap: 0.35rem;
            }
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--success-hover), var(--success-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-hover));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, var(--danger-hover), var(--danger-color));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .preset-btn {
            padding: 0.65rem 1rem;
            font-size: 0.95rem;
            font-weight: 600;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
        }

        .preset-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .inputs-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .input-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-shrink: 0;
            min-height: 0;
        }
        
        /* Compact input cards for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .input-card {
                padding: 0.5rem;
                gap: 0.3rem;
            }
            
            .input-card h3 {
                font-size: 0.85rem;
                gap: 0.3rem;
            }
        }

        .input-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        textarea {
            width: 100%;
            min-height: 70px;
            max-height: 100px;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            resize: none;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        /* Compact textareas for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            textarea {
                min-height: 50px;
                max-height: 70px;
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
            background: var(--bg-primary);
        }

        textarea[readonly] {
            background: var(--bg-tertiary);
            cursor: default;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-ready {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-processing {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Score Board Styles - Compact for iPad */
        .score-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 0;
            flex-shrink: 0;
        }
        
        .score-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-radius: var(--radius-lg);
            padding: 1rem 0.75rem;
            box-shadow: var(--shadow-md);
            border: 3px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Compact layout for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .score-board {
                gap: 0.5rem;
            }
            
            .score-card {
                padding: 0.5rem 0.4rem;
                border-width: 2px;
            }
            
            .score-icon {
                font-size: 1.25rem;
                margin-bottom: 0.2rem;
            }
            
            .score-value {
                font-size: 1.4rem;
                margin: 0.15rem 0;
            }
            
            .score-label {
                font-size: 0.7rem;
                letter-spacing: 0.3px;
            }
        }
        
        .score-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .score-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .score-icon {
            font-size: 1.75rem;
            margin-bottom: 0.35rem;
        }
        
        .score-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0.25rem 0;
            line-height: 1.1;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
        }
        
        .score-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
        }
        
        /* Challenges Section - Compact for iPad */
        .challenges-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }
        
        /* Compact challenges section for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .challenges-section {
                padding: 0.5rem;
                gap: 0.4rem;
            }
            
            .challenges-section h3 {
                font-size: 0.85rem;
                gap: 0.3rem;
            }
        }
        
        .challenges-section h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            flex-shrink: 0;
        }
        
        .challenge-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: var(--radius-md);
            padding: 0.6rem;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Compact challenge cards for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .challenge-card {
                padding: 0.4rem 0.5rem;
                gap: 0.4rem;
            }
            
            .challenge-icon {
                font-size: 1rem;
            }
            
            .challenge-text {
                font-size: 0.8rem;
            }
        }
        
        .challenge-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .challenge-content {
            flex: 1;
        }
        
        .challenge-card:hover {
            transform: translateX(5px);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        .challenge-card.active {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.1));
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }
        
        .challenge-card.completed {
            opacity: 0.6;
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            border-color: #999;
            cursor: not-allowed;
            pointer-events: all;
        }
        
        .challenge-card.completed:hover {
            transform: none;
            box-shadow: none;
        }
        
        .completed-badge {
            font-size: 1.5rem;
            animation: checkmarkPop 0.5s ease-out;
        }
        
        @keyframes checkmarkPop {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .challenge-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        
        .challenge-points {
            display: inline-block;
            background: var(--accent-yellow);
            color: var(--text-primary);
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: auto;
        }
        
        .difficulty-badge {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: var(--radius-sm);
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        
        .difficulty-easy { background: var(--success-color); color: white; }
        .difficulty-medium { background: var(--warning-color); color: white; }
        .difficulty-hard { background: var(--danger-color); color: white; }
        
        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background-color: var(--primary-color);
            animation: confetti-fall 3s linear forwards;
            z-index: 9999;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Bounce animation for buttons */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .btn-bounce {
            animation: bounce 2s infinite;
        }
        
        /* Success celebration */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            z-index: 10000;
            animation: celebrationPop 1.5s ease-out forwards;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8),
                         0 0 60px rgba(255, 107, 157, 0.6),
                         0 0 90px rgba(192, 132, 252, 0.4);
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
        }
        
        /* Modal notification overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10010;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
            border: 3px solid var(--border-color);
            animation: modalPop 0.3s ease-out;
            text-align: center;
        }
        
        .modal-content h3 {
            font-size: 2rem;
            margin: 0 0 1rem 0;
            color: var(--primary-color);
        }
        
        .modal-content p {
            font-size: 1.2rem;
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .modal-button {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-purple));
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalPop {
            0% { 
                transform: scale(0.7);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes celebrationPop {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            40% { 
                transform: translate(-50%, -50%) scale(1.3) rotate(10deg); 
                opacity: 1; 
            }
            60% { 
                transform: translate(-50%, -50%) scale(1.2) rotate(-5deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(0) rotate(180deg); 
                opacity: 0; 
            }
        }
        
        /* Timer display */
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .timer-display.warning {
            color: var(--danger-color);
            animation: pulse 1s infinite;
        }
        
        /* Streak indicator */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #ff6b9d, #ff9a76);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            box-shadow: var(--shadow-md);
            animation: pulse 2s infinite;
        }
        
        /* Game mode selector - Compact for side panel with 3 columns */
        .game-mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            flex-shrink: 0;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
        }
        
        /* Compact game mode buttons for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .game-mode-selector {
                padding: 0.5rem;
                gap: 0.3rem;
            }
        }
        
        .mode-btn {
            padding: 0.65rem 0.6rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
            font-size: 0.95rem;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        /* Compact mode buttons for iPad */
        @media (orientation: landscape) and (min-width: 768px) and (max-width: 1200px) {
            .mode-btn {
                padding: 0.45rem 0.4rem;
                font-size: 0.8rem;
            }
        }
        
        .mode-btn.full-width {
            grid-column: 1 / -1;
        }
        
        /* Keep 3 columns on narrow screens too */
        @media (max-width: 900px) {
            .game-mode-selector {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .mode-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-purple));
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }
        
        /* Leaderboard Styles - Modal version */
        .leaderboard-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
            overflow: hidden;
        }
        
        .leaderboard-section h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            flex-shrink: 0;
        }
        
        .leaderboard-container {
            margin-top: 0;
            padding-top: 0;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }
        
        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-color: #ffd700;
            font-weight: 700;
        }
        
        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            border-color: #c0c0c0;
            font-weight: 600;
        }
        
        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #cd7f32, #e8a87c);
            border-color: #cd7f32;
            font-weight: 600;
        }
        
        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 2.5rem;
            text-align: center;
        }
        
        .leaderboard-info {
            flex: 1;
            margin-left: 1rem;
        }
        
        .leaderboard-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .leaderboard-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .leaderboard-score {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            min-width: 4rem;
            text-align: right;
        }
        
        .leaderboard-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* Cartoon Name Modal */
        .name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10005;
            animation: fadeIn 0.3s ease-out;
        }
        
        .name-modal-content {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6f0 100%);
            border: 5px solid #ff6b9d;
            border-radius: 2rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 20px 60px rgba(255, 107, 157, 0.4),
                0 0 0 10px rgba(255, 255, 255, 0.5);
            animation: modalBounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
        }
        
        @keyframes modalBounceIn {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .name-modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .name-modal-header h2 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff6b9d;
            margin: 0 0 1rem 0;
            text-shadow: 
                3px 3px 0px #ffffff,
                4px 4px 0px #000000;
            animation: wiggle 1s ease-in-out infinite;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .name-modal-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4);
            border: 3px solid #ffaa00;
        }
        
        .name-modal-score span {
            font-size: 2rem;
            color: #ff6b9d;
        }
        
        .password-modal-warning {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
            border: 3px solid #ff0000;
            color: white;
        }
        
        .name-modal-body {
            margin-bottom: 2rem;
        }
        
        .name-modal-body label {
            display: block;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .name-input {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            font-family: 'Fredoka', 'Comic Neue', sans-serif;
            font-weight: 600;
            border: 4px solid #ff6b9d;
            border-radius: 1.5rem;
            background: white;
            color: #2d3748;
            text-align: center;
            box-shadow: 0 4px 10px rgba(255, 107, 157, 0.2);
            transition: all 0.3s ease;
        }
        
        .name-input:focus {
            outline: none;
            border-color: #c084fc;
            box-shadow: 0 0 0 4px rgba(192, 132, 252, 0.3);
            transform: scale(1.05);
        }
        
        .name-modal-footer {
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }
        
        .modal-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            border-radius: 1.5rem;
            border: 4px solid;
        }
        
        .modal-btn.btn-primary {
            animation: pulse 2s infinite;
        }
        
        /* Success flash overlay */
        .success-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, rgba(74, 222, 128, 0.4) 0%, transparent 70%);
            z-index: 9998;
            animation: flashEffect 0.6s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes flashEffect {
            0% { opacity: 0; }
            30% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; align-items: center; justify-content: center; width: 100%; position: relative;">
                <!-- Subtitle (left corner) -->
                <h1>
                    <i class="fas fa-star"></i>
                    AI Vision Quest!
                    <i class="fas fa-trophy"></i>
                </h1>
                
                <!-- Red Hat Family Day Branding - Centered and Prominent -->
                <div class="redhat-title" style="justify-content: center; align-items: center;">
                    <span class="party-emoji">ðŸŽ‰</span>
                    <span class="redhat-text">Red Hat Family Day 2025</span>
                    <span class="party-emoji party-emoji-2">ðŸŽŠ</span>
                </div>
                
                <!-- Controls (right corner) -->
                <div style="position: absolute; right: 0; display: flex; gap: 0.5rem;">
                    <button class="theme-toggle" id="musicToggle" title="Toggle music">
                        <i class="fas fa-music"></i>
                    </button>
                    <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="theme-toggle" id="settingsToggle" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Score Board -->
        <div class="score-board">
            <div class="score-card">
                <div class="score-icon">ðŸ†</div>
                <div class="score-value" id="totalScore">0</div>
                <div class="score-label">Points</div>
            </div>
            <div class="score-card">
                <div class="score-icon">â­</div>
                <div class="score-value" id="challengesCompleted">0</div>
                <div class="score-label">Challenges</div>
            </div>
            <div class="score-card">
                <div class="score-icon">ðŸ”¥</div>
                <div class="score-value" id="currentStreak">0</div>
                <div class="score-label">Streak</div>
            </div>
            <div class="score-card">
                <div class="score-icon">â±ï¸</div>
                <div class="score-value timer-display" id="gameTimer">0:00</div>
                <div class="score-label">Time</div>
            </div>
        </div>

        <!-- Split-Screen Layout -->
        <div class="main-content">
            <!-- Left Panel: Video Feed & Start Button -->
            <div class="game-panel">
                <div class="video-section">
                    <video id="videoFeed" autoplay playsinline></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <button id="flipCameraBtn" class="flip-camera-btn" onclick="switchCamera()" title="Switch Camera">
                        <i class="fas fa-camera-rotate"></i>
                    </button>
                    <div id="statusIndicator" class="status-indicator status-ready">
                        <i class="fas fa-circle"></i>
                        <span>ðŸŽ® Ready to play!</span>
                    </div>
                </div>

                <button id="startButton" class="btn btn-primary btn-bounce" style="flex-shrink: 0;">
                    <i class="fas fa-play"></i>
                    <span>Start Game! ðŸŽ®</span>
                </button>
            </div>
            
            <!-- Right Panel: Everything Else -->
            <div class="challenges-panel">
                <div class="game-mode-selector">
                    <button class="mode-btn active" data-mode="scavenger">ðŸ” Scavenger</button>
                    <button class="mode-btn" data-mode="emotions">ðŸ˜Š Emotions</button>
                    <button class="mode-btn" data-mode="colors">ðŸŽ¨ Colors</button>
                    <button class="mode-btn" data-mode="counting">ðŸ”¢ Counting</button>
                    <button class="mode-btn" data-mode="actions">ðŸ¤¸ Actions</button>
                    <button class="mode-btn" data-mode="bodyparts">âœ‹ Body Parts</button>
                </div>

                <div class="challenges-section">
                    <h3>
                        <i class="fas fa-gamepad"></i>
                        Available Challenges
                    </h3>
                    <div id="challengesList">
                        <!-- Challenges will be populated by JavaScript -->
                    </div>
                    <button class="btn btn-primary" onclick="generateNewChallenges()">
                        <i class="fas fa-shuffle"></i>
                        <span>New Challenges</span>
                    </button>
                </div>

                <div class="input-card">
                    <h3>
                        <i class="fas fa-bullseye"></i>
                        Current Challenge
                    </h3>
                    <textarea id="instructionText" placeholder="Click a challenge above!"></textarea>
                    
                    <button id="manualCompleteBtn" class="btn btn-primary" onclick="manualCompleteChallenge()" style="width: 100%; display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span id="manualBtnText">âœ… Award Points</span>
                    </button>
                </div>

                <div class="input-card">
                    <h3>
                        <i class="fas fa-robot"></i>
                        AI's Answer
                    </h3>
                    <textarea id="responseText" readonly placeholder="The AI will help you complete challenges! ðŸŽ‰"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Leaderboard Button -->
    <button class="floating-leaderboard-btn" onclick="openLeaderboard()" title="View Leaderboard">
        ðŸ†
    </button>

    <!-- Leaderboard Modal -->
    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-modal-content">
            <div class="leaderboard-modal-header">
                <h3>
                    <i class="fas fa-trophy"></i>
                    Top Players ðŸ†
                </h3>
                <button class="close-leaderboard-btn" onclick="closeLeaderboard()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="leaderboardList" class="leaderboard-list">
                <!-- Leaderboard will be populated by JavaScript -->
            </div>
            <button class="btn btn-danger" onclick="clearLeaderboard()" style="padding: 0.75rem;">
                <i class="fas fa-trash"></i>
                <span>Clear Leaderboard</span>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3>
                    <i class="fas fa-cog"></i>
                    Settings
                </h3>
                <button class="close-settings-btn" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('general')">
                    <i class="fas fa-sliders-h"></i>
                    General
                </button>
                <button class="settings-tab" onclick="switchSettingsTab('connection')">
                    <i class="fas fa-plug"></i>
                    vLLM Connection
                </button>
            </div>
            
            <!-- General Tab Content -->
            <div class="settings-tab-content active" id="generalTabContent">
                <div class="control-group">
                    <label for="difficultySelect">
                        <i class="fas fa-graduation-cap"></i>
                        Difficulty Level
                    </label>
                    <select id="difficultySelect">
                        <option value="easy" selected>Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                        ðŸ’¡ Easy: Very encouraging, flexible scoring | Medium: Balanced | Hard: Strict evaluation
                    </div>
                </div>
                <div class="control-group">
                    <label for="intervalSelect">
                        <i class="fas fa-clock"></i>
                        Request Interval
                    </label>
                    <select id="intervalSelect">
                        <option value="1000" selected>1 second</option>
                        <option value="2000">2 seconds</option>
                        <option value="3000">3 seconds</option>
                        <option value="5000">5 seconds</option>
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                        ðŸ’¡ Qwen2-VL-2B has good instruction following and runs faster than larger models
                    </div>
                </div>
            </div>
            
            <!-- vLLM Connection Tab Content -->
            <div class="settings-tab-content" id="connectionTabContent">
                <div class="control-group">
                    <label for="vllmEndpointSelect">
                        <i class="fas fa-server"></i>
                        RHAIIS vLLM Endpoint
                    </label>
                    <select id="vllmEndpointSelect" onchange="handleVllmEndpointChange()">
                        <option value="https://rhaiis-route-rhaiis.apps.cluster-pjc5d.pjc5d.sandbox1225.opentlc.com">External Route (Default)</option>
                        <option value="custom">Custom Endpoint...</option>
                    </select>
                    <div id="customVllmEndpointWrapper" style="display: none; margin-top: 0.5rem;">
                        <div class="input-wrapper">
                            <input type="text" id="baseURL" placeholder="Enter custom endpoint URL (e.g., https://api.openai.com)">
                        </div>
                        <div class="input-wrapper" style="margin-top: 0.5rem;">
                            <input type="password" id="apiKey" placeholder="API Key (optional - required for some endpoints)">
                        </div>
                        <div class="input-wrapper" style="margin-top: 0.5rem;">
                            <button id="fetchModelsBtn" class="btn btn-primary" onclick="fetchAvailableModels()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                <i class="fas fa-download"></i>
                                <span>Fetch Available Models</span>
                            </button>
                        </div>
                        <div class="input-wrapper" style="margin-top: 0.5rem;">
                            <select id="modelSelect" disabled>
                                <option value="">Select a model (fetch models first)</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                        ðŸ’¡ <strong>Enterprise Setup:</strong> Using Red Hat AI Inference Server (RHAIIS) with vLLM backend.<br>
                        <strong>Default:</strong> Uses external route (rhaiis-route-rhaiis.apps.cluster-pjc5d.pjc5d.sandbox1225.opentlc.com)<br>
                        <strong>Model:</strong> Qwen2-VL-2B-Instruct (Vision Language Model)<br>
                        <strong>API:</strong> OpenAI-compatible (Port 8000)
                    </div>
                </div>

                <div class="control-group">
                    <button id="testConnectionBtn" class="btn btn-primary" onclick="testConnection()" style="width: 100%;">
                        <i class="fas fa-wifi"></i>
                        <span>Test VLM Connection</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cartoon Name Input Modal -->
    <div id="nameModal" class="name-modal" style="display: none;">
        <div class="name-modal-content">
            <div class="name-modal-header">
                <h2>ðŸŽ‰ AWESOME JOB! ðŸŽ‰</h2>
                <div class="name-modal-score">You scored <span id="modalScore">0</span> points!</div>
            </div>
            <div class="name-modal-body">
                <label for="playerNameInput">Enter your name:</label>
                <input type="text" id="playerNameInput" class="name-input" placeholder="Super Player" maxlength="20" />
            </div>
            <div class="name-modal-footer">
                <button class="btn btn-primary modal-btn" onclick="submitName()">
                    <i class="fas fa-trophy"></i>
                    <span>Add to Leaderboard! ðŸ†</span>
                </button>
                <button class="btn btn-danger modal-btn" onclick="skipLeaderboard()">
                    <span>Skip</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Cartoon Password Modal -->
    <div id="passwordModal" class="name-modal" style="display: none;">
        <div class="name-modal-content">
            <div class="name-modal-header">
                <h2>ðŸ”’ ADMIN ACCESS ðŸ”’</h2>
                <div class="password-modal-warning">âš ï¸ Clear Leaderboard âš ï¸</div>
            </div>
            <div class="name-modal-body">
                <label for="adminPasswordInput">Enter admin password:</label>
                <input type="password" id="adminPasswordInput" class="name-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="50" />
            </div>
            <div class="name-modal-footer">
                <button class="btn btn-danger modal-btn" onclick="submitPassword()" style="animation: pulse 2s infinite;">
                    <i class="fas fa-trash"></i>
                    <span>Clear Leaderboard</span>
                </button>
                <button class="btn btn-primary modal-btn" onclick="cancelPassword()">
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Challenge Selection Prompt Modal -->
    <div id="challengePromptModal" class="name-modal" style="display: none;">
        <div class="name-modal-content">
            <div class="name-modal-header">
                <h2>âš ï¸ PICK A CHALLENGE! âš ï¸</h2>
                <div class="password-modal-warning" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                    ðŸŽ¯ Select a Challenge First
                </div>
            </div>
            <div class="name-modal-body">
                <label style="font-size: 1.1rem; line-height: 1.6;">
                    Please click on one of the challenge cards on the right before starting the game!
                    <br><br>
                    ðŸ‘‰ Look for the colorful cards
                    <br>
                    ðŸŽ® Pick one to play!
                </label>
            </div>
            <div class="name-modal-footer">
                <button class="btn btn-primary modal-btn" onclick="closeChallengePrompt()" style="animation: pulse 2s infinite;">
                    <i class="fas fa-check-circle"></i>
                    <span>Got It! ðŸ‘</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const baseURL = document.getElementById('baseURL');
        const instructionText = document.getElementById('instructionText');
        const responseText = document.getElementById('responseText');
        const modelSelect = document.getElementById('modelSelect');
        const intervalSelect = document.getElementById('intervalSelect');
        const startButton = document.getElementById('startButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const themeToggle = document.getElementById('themeToggle');

        // Game state variables
        let gameState = {
            score: 0,
            challengesCompleted: 0,
            streak: 0,
            startTime: null,
            timerInterval: null,
            currentChallenge: null,
            currentMode: 'scavenger',
            difficulty: 'easy', // Default difficulty level
            completedChallenges: new Set(), // Track completed challenges
            challengeStartTime: null, // Track when current challenge was selected
            minChallengeDuration: 3000 // Minimum 3 seconds before challenge can be completed
        };
        
        // Challenge definitions by category
        const challengeCategories = {
            scavenger: [
                { text: "Find something red!", points: 10, difficulty: "easy" },
                { text: "Show me a book!", points: 15, difficulty: "easy" },
                { text: "Find something round!", points: 10, difficulty: "easy" },
                { text: "Show me a cup or mug!", points: 15, difficulty: "easy" },
                { text: "Find something with buttons!", points: 20, difficulty: "medium" },
                { text: "Show me a plant or flower!", points: 15, difficulty: "easy" },
                { text: "Find something that writes!", points: 10, difficulty: "easy" },
                { text: "Show me your favorite toy!", points: 20, difficulty: "medium" },
                { text: "Find something blue!", points: 10, difficulty: "easy" },
                { text: "Show me something soft and fluffy!", points: 25, difficulty: "medium" },
                { text: "Find something made of paper!", points: 15, difficulty: "easy" },
                { text: "Show me a chair or seat!", points: 10, difficulty: "easy" },
                { text: "Find something shiny!", points: 20, difficulty: "medium" },
                { text: "Show me something from the kitchen!", points: 20, difficulty: "medium" },
                { text: "Find something with wheels!", points: 25, difficulty: "medium" },
                { text: "Show me eyeglasses or sunglasses!", points: 20, difficulty: "medium" },
                { text: "Find something rectangular!", points: 15, difficulty: "easy" },
                { text: "Show me a phone or tablet!", points: 15, difficulty: "easy" },
            ],
            emotions: [
                { text: "Make the funniest silly face ever! ðŸ¤ª", points: 25, difficulty: "medium" },
                { text: "Show me your BEST surprised face! ðŸ˜®", points: 25, difficulty: "medium" },
                { text: "Can you make a grumpy old person face?", points: 30, difficulty: "hard" },
                { text: "Make your CRAZIEST excited face!", points: 25, difficulty: "medium" },
                { text: "Show me a sneaky ninja face! ðŸ¥·", points: 30, difficulty: "hard" },
                { text: "Make a super sleepy yawn face! ðŸ˜´", points: 25, difficulty: "medium" },
                { text: "Can you look like a confused robot? ðŸ¤–", points: 35, difficulty: "hard" },
                { text: "Make your silliest laughing face! ðŸ˜„", points: 25, difficulty: "medium" },
                { text: "Show me a cool superhero face! ðŸ˜Ž", points: 30, difficulty: "hard" },
                { text: "Make the BIGGEST scary monster face!", points: 35, difficulty: "hard" },
                { text: "Can you look like a surprised monkey? ðŸµ", points: 35, difficulty: "hard" },
                { text: "Show me your best thinking genius face! ðŸ¤”", points: 30, difficulty: "hard" },
            ],
            colors: [
                { text: "What colors do you see in this image?", points: 15, difficulty: "easy" },
                { text: "Show me something red!", points: 10, difficulty: "easy" },
                { text: "Show me something blue!", points: 10, difficulty: "easy" },
                { text: "Show me something yellow!", points: 10, difficulty: "easy" },
                { text: "Find something green!", points: 10, difficulty: "easy" },
                { text: "Show me 3 different colored objects!", points: 30, difficulty: "hard" },
                { text: "Find something orange!", points: 10, difficulty: "easy" },
                { text: "Show me something purple!", points: 10, difficulty: "easy" },
                { text: "Find something pink!", points: 10, difficulty: "easy" },
                { text: "Show me something white!", points: 10, difficulty: "easy" },
                { text: "Find something black!", points: 10, difficulty: "easy" },
                { text: "Show me the brightest thing you can find!", points: 20, difficulty: "medium" },
            ],
            counting: [
                { text: "Show me 1 object!", points: 10, difficulty: "easy" },
                { text: "Show me 2 of the same thing!", points: 20, difficulty: "medium" },
                { text: "Show me 3 different things!", points: 30, difficulty: "medium" },
                { text: "Show me 4 things!", points: 35, difficulty: "hard" },
                { text: "Show me 5 fingers!", points: 20, difficulty: "easy" },
                { text: "Find a pair of something!", points: 25, difficulty: "medium" },
                { text: "Show me more than 3 objects!", points: 30, difficulty: "medium" },
                { text: "Show me exactly 3 toys or objects!", points: 35, difficulty: "hard" },
                { text: "Find 2 books or papers!", points: 25, difficulty: "medium" },
                { text: "Show me 10 fingers!", points: 20, difficulty: "easy" },
            ],
            actions: [
                { text: "Wave hello to the camera!", points: 15, difficulty: "easy" },
                { text: "Give a thumbs up! ðŸ‘", points: 10, difficulty: "easy" },
                { text: "Clap your hands!", points: 15, difficulty: "easy" },
                { text: "Jump up and down!", points: 20, difficulty: "medium" },
                { text: "Do a silly dance!", points: 25, difficulty: "medium" },
                { text: "Touch your nose!", points: 15, difficulty: "easy" },
                { text: "Make a peace sign! âœŒï¸", points: 15, difficulty: "easy" },
                { text: "Point at the camera!", points: 10, difficulty: "easy" },
                { text: "Spin around in a circle!", points: 20, difficulty: "medium" },
                { text: "Stand on one foot!", points: 20, difficulty: "medium" },
                { text: "Touch your toes!", points: 20, difficulty: "medium" },
                { text: "Make a heart with your hands! â¤ï¸", points: 25, difficulty: "medium" },
            ],
            bodyparts: [
                { text: "Show me your hands!", points: 10, difficulty: "easy" },
                { text: "Point to your eyes!", points: 10, difficulty: "easy" },
                { text: "Show me your feet!", points: 15, difficulty: "easy" },
                { text: "Touch your ears!", points: 15, difficulty: "easy" },
                { text: "Show me your hair!", points: 10, difficulty: "easy" },
                { text: "How many fingers can you wiggle?", points: 20, difficulty: "medium" },
                { text: "Show me your elbow!", points: 15, difficulty: "easy" },
                { text: "Point to your mouth!", points: 10, difficulty: "easy" },
                { text: "Show me your knees!", points: 15, difficulty: "easy" },
                { text: "Make bunny ears with your hands!", points: 20, difficulty: "medium" },
                { text: "Show me both your hands!", points: 15, difficulty: "easy" },
                { text: "Wiggle your fingers!", points: 20, difficulty: "medium" },
            ]
        };

        // Set default values
        instructionText.value = "Click 'Start' and show me cool things! ðŸŽ®";
        
        // Leaderboard Functions
        function loadLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('aiVisionQuestLeaderboard') || '[]');
            return leaderboard;
        }
        
        function saveLeaderboard(leaderboard) {
            localStorage.setItem('aiVisionQuestLeaderboard', JSON.stringify(leaderboard));
        }
        
        function displayLeaderboard() {
            const leaderboard = loadLeaderboard();
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<div class="leaderboard-empty">No scores yet! Be the first to play! ðŸŽ®</div>';
                return;
            }
            
            // Sort by score (highest first)
            leaderboard.sort((a, b) => b.score - a.score);
            
            // Display top 10
            leaderboardList.innerHTML = leaderboard.slice(0, 10).map((entry, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : `${rank}.`;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                
                return `
                    <div class="leaderboard-item ${rankClass}">
                        <div class="leaderboard-rank">${medal}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${entry.name}</div>
                            <div class="leaderboard-details">
                                ${entry.challenges} challenges â€¢ ${entry.streak} streak â€¢ ${entry.time}
                            </div>
                        </div>
                        <div class="leaderboard-score">${entry.score}</div>
                    </div>
                `;
            }).join('');
        }
        
        function addToLeaderboard(name, score, challenges, streak, time) {
            const leaderboard = loadLeaderboard();
            const entry = {
                name: name,
                score: score,
                challenges: challenges,
                streak: streak,
                time: time,
                date: new Date().toLocaleDateString()
            };
            
            leaderboard.push(entry);
            saveLeaderboard(leaderboard);
            displayLeaderboard();
        }
        
        function clearLeaderboard() {
            // Show password modal instead of prompt
            showPasswordModal();
        }
        
        function showPasswordModal() {
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('adminPasswordInput').focus();
        }
        
        function hidePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }
        
        function submitPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            
            // Check password (default: "redhat2025")
            if (password === '2025') {
                hidePasswordModal();
                
                // Clear leaderboard directly
                localStorage.removeItem('aiVisionQuestLeaderboard');
                displayLeaderboard();
                showCelebration('ðŸ—‘ï¸');
                
                // Show success message
                responseText.value = 'âœ… Leaderboard cleared successfully!\n\nAll scores have been deleted.';
            } else {
                showModal('âŒ Incorrect Password', 'The password you entered is incorrect. Leaderboard not cleared.', 'Try Again');
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }
        
        function cancelPassword() {
            hidePasswordModal();
        }
        
        // Challenge Prompt Modal Functions
        function showChallengePrompt() {
            document.getElementById('challengePromptModal').style.display = 'flex';
        }
        
        function closeChallengePrompt() {
            document.getElementById('challengePromptModal').style.display = 'none';
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Cartoon Modal Functions
        let pendingLeaderboardData = null;
        
        function showNameModal(score, challenges, streak, time) {
            pendingLeaderboardData = { score, challenges, streak, time };
            document.getElementById('modalScore').textContent = score;
            document.getElementById('playerNameInput').value = '';
            const modal = document.getElementById('nameModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            setTimeout(() => {
                const input = document.getElementById('playerNameInput');
                if (input) {
                    input.focus();
                }
            }, 100);
        }
        
        function hideNameModal() {
            const modal = document.getElementById('nameModal');
            if (modal) {
                modal.style.display = 'none';
            }
            pendingLeaderboardData = null;
        }
        
        function submitName() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            
            if (!playerName) {
                showModal('âš ï¸ Name Required', 'Please enter your name to save your score! ðŸ†', 'OK');
                return;
            }
            
            if (pendingLeaderboardData) {
                addToLeaderboard(
                    playerName,
                    pendingLeaderboardData.score,
                    pendingLeaderboardData.challenges,
                    pendingLeaderboardData.streak,
                    pendingLeaderboardData.time
                );
                
                showCelebration('ðŸ†');
                createConfetti();
                
                responseText.value = `ðŸ† ${playerName} added to leaderboard!\n\nðŸŽ® Final Score: ${pendingLeaderboardData.score} points\nâ­ Challenges: ${pendingLeaderboardData.challenges}\nðŸ”¥ Streak: ${pendingLeaderboardData.streak}\nâ±ï¸ Time: ${pendingLeaderboardData.time}\n\nCheck the leaderboard! ðŸ‘‰`;
            }
            
            // Clear pending data
            pendingLeaderboardData = null;
            hideNameModal();
        }
        
        function skipLeaderboard() {
            if (pendingLeaderboardData) {
                responseText.value = `ðŸŽ® Game Stopped!\n\nðŸ† Total Score: ${pendingLeaderboardData.score}\nâ­ Challenges Completed: ${pendingLeaderboardData.challenges}\nðŸ”¥ Best Streak: ${pendingLeaderboardData.streak}\nâ±ï¸ Time: ${pendingLeaderboardData.time}\n\nGreat job! Click Start to play again! ðŸŽ‰`;
            }
            // Clear pending data
            pendingLeaderboardData = null;
            hideNameModal();
        }
        
        // Handle Enter key in name and password inputs
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitName();
                    }
                });
            }
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitPassword();
                    }
                });
            }
        });
        
        // Gaming Functions
        function getChallengeIcon(challengeText, mode) {
            // Extract emoji if it exists in the challenge text
            const emojiMatch = challengeText.match(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u);
            if (emojiMatch) {
                return emojiMatch[0];
            }
            
            // Mode-specific icons based on keywords
            const text = challengeText.toLowerCase();
            
            if (mode === 'scavenger') {
                if (text.includes('red')) return 'ðŸ”´';
                if (text.includes('book')) return 'ðŸ“š';
                if (text.includes('round')) return 'âšª';
                if (text.includes('cup') || text.includes('mug')) return 'â˜•';
                if (text.includes('button')) return 'ðŸ”˜';
                if (text.includes('plant') || text.includes('flower')) return 'ðŸŒ¸';
                if (text.includes('write')) return 'âœï¸';
                if (text.includes('toy')) return 'ðŸ§¸';
                if (text.includes('blue')) return 'ðŸ”µ';
                if (text.includes('soft') || text.includes('fluffy')) return 'ðŸ§¸';
                if (text.includes('paper')) return 'ðŸ“„';
                if (text.includes('chair') || text.includes('seat')) return 'ðŸª‘';
                if (text.includes('shiny')) return 'âœ¨';
                if (text.includes('kitchen')) return 'ðŸ´';
                if (text.includes('wheel')) return 'ðŸš—';
                if (text.includes('glasses')) return 'ðŸ‘“';
                if (text.includes('rectangular')) return 'ðŸ“±';
                if (text.includes('phone') || text.includes('tablet')) return 'ðŸ“±';
                return 'ðŸ”';
            }
            
            if (mode === 'colors') {
                if (text.includes('red')) return 'ðŸ”´';
                if (text.includes('blue')) return 'ðŸ”µ';
                if (text.includes('yellow')) return 'ðŸŸ¡';
                if (text.includes('green')) return 'ðŸŸ¢';
                if (text.includes('orange')) return 'ðŸŸ ';
                if (text.includes('purple')) return 'ðŸŸ£';
                if (text.includes('pink')) return 'ðŸ’—';
                if (text.includes('white')) return 'âšª';
                if (text.includes('black')) return 'âš«';
                if (text.includes('bright')) return 'ðŸ’¡';
                return 'ðŸŽ¨';
            }
            
            if (mode === 'counting') {
                if (text.includes('finger')) return 'ðŸ–ï¸';
                if (text.includes('hand')) return 'âœ‹';
                return 'ðŸ”¢';
            }
            
            if (mode === 'actions') {
                if (text.includes('wave')) return 'ðŸ‘‹';
                if (text.includes('thumbs')) return 'ðŸ‘';
                if (text.includes('clap')) return 'ðŸ‘';
                if (text.includes('jump')) return 'ðŸ¦˜';
                if (text.includes('dance')) return 'ðŸ’ƒ';
                if (text.includes('nose')) return 'ðŸ‘ƒ';
                if (text.includes('peace')) return 'âœŒï¸';
                if (text.includes('point')) return 'ðŸ‘‰';
                if (text.includes('spin')) return 'ðŸŒ€';
                if (text.includes('foot')) return 'ðŸ¦¶';
                if (text.includes('toe')) return 'ðŸ¦¶';
                if (text.includes('heart')) return 'â¤ï¸';
                return 'ðŸ¤¸';
            }
            
            if (mode === 'bodyparts') {
                if (text.includes('hand')) return 'âœ‹';
                if (text.includes('eye')) return 'ðŸ‘ï¸';
                if (text.includes('feet') || text.includes('foot')) return 'ðŸ¦¶';
                if (text.includes('ear')) return 'ðŸ‘‚';
                if (text.includes('hair')) return 'ðŸ’‡';
                if (text.includes('finger')) return 'ðŸ‘†';
                if (text.includes('elbow')) return 'ðŸ’ª';
                if (text.includes('mouth')) return 'ðŸ‘„';
                if (text.includes('knee')) return 'ðŸ¦µ';
                if (text.includes('bunny')) return 'ðŸ°';
                return 'âœ‹';
            }
            
            // Default icons per mode
            const modeIcons = {
                'scavenger': 'ðŸ”',
                'emotions': 'ðŸ˜Š',
                'colors': 'ðŸŽ¨',
                'counting': 'ðŸ”¢',
                'actions': 'ðŸ¤¸',
                'bodyparts': 'âœ‹'
            };
            
            return modeIcons[mode] || 'â­';
        }
        
        function generateNewChallenges() {
            const challengesList = document.getElementById('challengesList');
            const mode = gameState.currentMode;
            const challenges = challengeCategories[mode];
            
            // Clear completed challenges when generating new set
            gameState.completedChallenges.clear();
            
            // Shuffle and select random challenges
            const shuffled = [...challenges].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, 5);
            
            challengesList.innerHTML = '';
            selected.forEach((challenge, index) => {
                // Create unique ID for this challenge instance
                const challengeId = `${mode}_${index}_${Date.now()}`;
                challenge.id = challengeId;
                
                const icon = getChallengeIcon(challenge.text, mode);
                
                const card = document.createElement('div');
                card.className = 'challenge-card';
                card.dataset.challengeId = challengeId;
                card.innerHTML = `
                    <div class="challenge-icon">${icon}</div>
                    <div class="challenge-content">
                        <div class="challenge-title">
                            <span>${challenge.text}</span>
                            <span class="challenge-points">+${challenge.points}</span>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span class="difficulty-badge difficulty-${challenge.difficulty}">${challenge.difficulty}</span>
                        </div>
                    </div>
                `;
                card.onclick = () => selectChallenge(challenge, card);
                challengesList.appendChild(card);
            });
        }
        
        function selectChallenge(challenge, cardElement) {
            // Check if challenge is already completed
            if (gameState.completedChallenges.has(challenge.id)) {
                showModal('â­ Already Completed!', 'You already completed this challenge! Pick a new one to keep playing! ðŸŽ®', 'Choose Another! ðŸŽ¯');
                return;
            }
            
            // Record when this challenge was selected (prevents instant wins)
            gameState.challengeStartTime = Date.now();
            
            // Remove active class from all cards
            document.querySelectorAll('.challenge-card').forEach(c => c.classList.remove('active'));
            // Add active class to selected card
            cardElement.classList.add('active');
            
            // Set the challenge based on game mode
            const cleanChallenge = challenge.text.replace('!', '').replace('?', '');
            const mode = gameState.currentMode;
            const challengeLower = cleanChallenge.toLowerCase();
            const difficulty = gameState.difficulty;
            
            // Get difficulty-specific instructions
            const getDifficultyInstructions = () => {
                if (difficulty === 'easy') {
                    return {
                        tone: 'Be VERY encouraging and flexible!',
                        tolerance: 'Accept close attempts and give them credit for trying.',
                        accuracy: 'within +/- 1 is okay',
                        colorMatch: '(or similar shades like light/dark)',
                        encouragement: 'Be super positive!'
                    };
                } else if (difficulty === 'medium') {
                    return {
                        tone: 'Be encouraging but look for reasonable accuracy.',
                        tolerance: 'They should be close to the target.',
                        accuracy: 'should be fairly accurate',
                        colorMatch: '(or close shades)',
                        encouragement: 'Be supportive but fair.'
                    };
                } else { // hard
                    return {
                        tone: 'Be strict and look for exact matches.',
                        tolerance: 'They must match exactly.',
                        accuracy: 'must be exact',
                        colorMatch: '',
                        encouragement: 'Only say YES if it\'s clearly correct.'
                    };
                }
            };
            
            const diffInstructions = getDifficultyInstructions();
            
            let prompt = '';
            
            if (mode === 'colors') {
                // Check if it's asking for specific color (YES/NO) or describing (open-ended)
                if (challengeLower.includes('what colors')) {
                    prompt = `Look at this image and describe what you see. List all the colors you can see in the image. This is for kids ages 5-10 learning colors - be encouraging and help them identify colors!`;
                } else {
                    // Extract the specific color from the challenge
                    let specificColor = '';
                    const colors = ['red', 'blue', 'yellow', 'green', 'orange', 'purple', 'pink', 'white', 'black', 'bright'];
                    for (const color of colors) {
                        if (challengeLower.includes(color)) {
                            specificColor = color;
                            break;
                        }
                    }
                    
                    prompt = `Look at this image! Do you see any ${specificColor ? specificColor : 'this color'} color? \n\nThis is for kids ages 5-10 learning colors. Say YES if you see ${specificColor ? specificColor : 'the color'} ${diffInstructions.colorMatch}. ${diffInstructions.tone} ${diffInstructions.tolerance} Say NO if it's a completely different color.\n\nFormat: YES - [reason] or NO - [reason]`;
                }
            } else if (mode === 'counting') {
                // Extract the number from the challenge
                let extractedNumber = '';
                const numberMatch = cleanChallenge.match(/\b(1|one|2|two|3|three|4|four|5|five|10|ten|pair|more than \d+)\b/i);
                if (numberMatch) {
                    extractedNumber = numberMatch[0];
                }
                
                prompt = `Look at this image! Can you see ${extractedNumber ? extractedNumber : 'that many'} things?\n\nThis is for kids ages 5-10 learning to count. The challenge is: "${cleanChallenge}". ${diffInstructions.tone} Say YES if they're actively trying to show ${extractedNumber ? extractedNumber : 'the right number of'} things (count ${diffInstructions.accuracy}). ${diffInstructions.tolerance} Say NO if not matching the challenge.\n\nFormat: YES - [reason] or NO - [reason]`;
            } else if (mode === 'bodyparts') {
                // For body parts, make sure it's the correct part
                if (challengeLower.includes('how many') || challengeLower.includes('count')) {
                    prompt = `Look at this image. Count what you see and tell me the number. The challenge is: "${cleanChallenge}". This is for kids ages 5-10 - ${diffInstructions.encouragement} Count ${diffInstructions.accuracy}.`;
                } else {
                    // Extract the specific body part from the challenge
                    let specificPart = '';
                    const bodyParts = ['hands', 'hand', 'eyes', 'eye', 'feet', 'foot', 'ears', 'ear', 'hair', 'fingers', 'finger', 'elbow', 'mouth', 'knees', 'knee', 'nose', 'toes'];
                    for (const part of bodyParts) {
                        if (challengeLower.includes(part)) {
                            specificPart = part;
                            break;
                        }
                    }
                    
                    prompt = `Look at this image! Can you see ${specificPart ? specificPart : 'this body part'}?\n\nThis is for kids ages 5-10 learning body parts. ${diffInstructions.tone} Say YES if you can clearly see ${specificPart ? specificPart : 'the body part'} in the image. ${diffInstructions.tolerance} Say NO if it's a different body part or not visible.\n\nFormat: YES - [reason] or NO - [reason]`;
                }
            } else if (mode === 'emotions') {
                // For emotions, look for EXAGGERATED and FUNNY expressions
                // Extract the specific emotion or character from the challenge
                let specificEmotion = '';
                let requiresExaggeration = false;
                
                // Map complex emotion challenges to what to look for
                if (challengeLower.includes('silly') || challengeLower.includes('funniest')) {
                    specificEmotion = 'VERY silly or funny';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('surprised') || challengeLower.includes('best surprised')) {
                    specificEmotion = 'VERY surprised with wide eyes';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('grumpy')) {
                    specificEmotion = 'grumpy old person (frowning, grumpy expression)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('excited') || challengeLower.includes('craziest')) {
                    specificEmotion = 'EXTREMELY excited (big smile, wide eyes)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('ninja') || challengeLower.includes('sneaky')) {
                    specificEmotion = 'sneaky ninja (squinting eyes, sneaky look)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('yawn') || challengeLower.includes('sleepy')) {
                    specificEmotion = 'super sleepy yawning (big open mouth yawn)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('robot') || challengeLower.includes('confused')) {
                    specificEmotion = 'confused robot (blank or confused stare)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('laughing')) {
                    specificEmotion = 'laughing hard (big laugh, open mouth)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('superhero') || challengeLower.includes('cool')) {
                    specificEmotion = 'cool superhero (confident, cool pose)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('scary') || challengeLower.includes('monster')) {
                    specificEmotion = 'SCARY monster face (scary expression, big mouth)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('monkey')) {
                    specificEmotion = 'surprised monkey (wide eyes, open mouth)';
                    requiresExaggeration = true;
                } else if (challengeLower.includes('thinking') || challengeLower.includes('genius')) {
                    specificEmotion = 'thinking genius (hand on chin, thinking pose)';
                    requiresExaggeration = true;
                }
                
                if (requiresExaggeration) {
                    const exaggerationLevel = difficulty === 'easy' ? 'trying to show' : difficulty === 'medium' ? 'showing a clear' : 'making a BIG, EXAGGERATED';
                    prompt = `Look at this image! Can you see a ${specificEmotion} face or expression?\n\nThis is for kids ages 5-10 doing FUNNY emotion challenges. The challenge is: "${cleanChallenge}". ${diffInstructions.tone} Say YES if they're ${exaggerationLevel} expression that shows ${specificEmotion}. ${diffInstructions.tolerance} Say NO if not matching the challenge.\n\nFormat: YES - [reason] or NO - [reason]`;
                } else {
                    prompt = `Look at this image! Can you see this emotion or expression?\n\nThis is for kids ages 5-10. The challenge is: "${cleanChallenge}". ${diffInstructions.tone} Say YES if they're clearly showing this expression. ${diffInstructions.tolerance} Say NO if not matching.\n\nFormat: YES - [reason] or NO - [reason]`;
                }
            } else {
                // For scavenger and actions - use YES/NO format
                // Try to extract key items/actions from the challenge
                let keyItem = '';
                
                // Common scavenger items
                if (challengeLower.includes('book')) keyItem = 'a BOOK';
                else if (challengeLower.includes('cup') || challengeLower.includes('mug')) keyItem = 'a CUP or MUG';
                else if (challengeLower.includes('plant') || challengeLower.includes('flower')) keyItem = 'a PLANT or FLOWER';
                else if (challengeLower.includes('toy')) keyItem = 'a TOY';
                else if (challengeLower.includes('phone') || challengeLower.includes('tablet')) keyItem = 'a PHONE or TABLET';
                else if (challengeLower.includes('glasses')) keyItem = 'GLASSES';
                
                // Common actions
                else if (challengeLower.includes('wave')) keyItem = 'someone WAVING';
                else if (challengeLower.includes('thumbs')) keyItem = 'a THUMBS UP';
                else if (challengeLower.includes('clap')) keyItem = 'someone CLAPPING';
                else if (challengeLower.includes('jump')) keyItem = 'someone JUMPING';
                else if (challengeLower.includes('dance')) keyItem = 'someone DANCING';
                else if (challengeLower.includes('peace')) keyItem = 'a PEACE SIGN';
                else if (challengeLower.includes('heart')) keyItem = 'a HEART shape made with hands';
                
                prompt = `Look at this image! Can you see ${keyItem || 'this'}?\n\nThis is for kids ages 5-10 on a scavenger hunt or doing actions. ${diffInstructions.tone} Say YES if you can see ${keyItem || 'what they need to show'} in the image. ${diffInstructions.tolerance} Say NO if it's clearly not there or they're showing something completely different.\n\nFormat: YES - [reason] or NO - [reason]`;
            }
            
            instructionText.value = prompt;
            gameState.currentChallenge = challenge;
            console.log('ðŸŽ¯ Challenge selected:', challenge.text);
            console.log('ðŸ“ Prompt created:', prompt);
            
            // Play selection sound
            playSound('select');
            
            // Show manual complete button and update styling
            const manualBtn = document.getElementById('manualCompleteBtn');
            const manualBtnText = document.getElementById('manualBtnText');
            manualBtn.style.display = 'flex';
            
            // Update response based on challenge type
            const isOpenEnded = 
                cleanChallenge.toLowerCase().includes('what colors') ||
                cleanChallenge.toLowerCase().includes('how many') ||
                cleanChallenge.toLowerCase().includes('count');
            
            if (isOpenEnded) {
                // For open-ended, make button more prominent
                manualBtn.style.animation = 'pulse 2s infinite';
                manualBtnText.textContent = 'âœ… Click Here to Award Points!';
                responseText.value = `ðŸŽ¯ Challenge Active: ${challenge.text}\n\nShow the camera when you're ready!\n\nðŸ“ This is an open-ended challenge - the AI will describe what it sees.\nIf the answer is correct, click the green âœ… button below to award ${challenge.points} points! ðŸ†`;
            } else {
                // For auto-scoring challenges, button is backup option
                manualBtn.style.animation = '';
                manualBtnText.textContent = 'âœ… Award Points (Manual)';
                responseText.value = `ðŸŽ¯ Challenge Active: ${challenge.text}\n\nShow the camera when you're ready!\n\nâœ… Auto-scoring: ${challenge.points} points if AI says YES!\n(Or use the manual button if needed)`;
            }
            
            // Play a fun sound effect
            playSuccessSound();
        }
        
        function manualCompleteChallenge() {
            if (gameState.currentChallenge) {
                const points = gameState.currentChallenge.points;
                updateScore(points);
                
                responseText.value = `âœ… MANUAL POINTS AWARDED!\n\nðŸŽ‰ AWESOME! You earned ${points} points!\n\nPick another challenge to continue!`;
                
                // Clear the active challenge
                document.querySelectorAll('.challenge-card').forEach(c => c.classList.remove('active'));
                gameState.currentChallenge = null;
                gameState.challengeStartTime = null; // Reset timer
                
                // Hide and reset manual button
                const manualBtn = document.getElementById('manualCompleteBtn');
                manualBtn.style.display = 'none';
                manualBtn.style.animation = '';
                
                updateStatus('ready', 'ðŸŽ‰ Challenge complete! Pick another!', 'star');
            }
        }
        
        function updateScore(points) {
            // Mark current challenge as completed
            if (gameState.currentChallenge && gameState.currentChallenge.id) {
                gameState.completedChallenges.add(gameState.currentChallenge.id);
                
                // Mark the challenge card as completed
                const challengeCard = document.querySelector(`[data-challenge-id="${gameState.currentChallenge.id}"]`);
                if (challengeCard) {
                    challengeCard.classList.add('completed');
                    challengeCard.classList.remove('active');
                    // Add checkmark to completed challenge (after the icon)
                    const contentDiv = challengeCard.querySelector('.challenge-content');
                    if (contentDiv && !contentDiv.querySelector('.completed-badge')) {
                        const checkmark = document.createElement('span');
                        checkmark.className = 'completed-badge';
                        checkmark.innerHTML = 'âœ…';
                        checkmark.style.marginRight = '0.5rem';
                        contentDiv.insertBefore(checkmark, contentDiv.firstChild);
                    }
                }
            }
            
            gameState.score += points;
            gameState.challengesCompleted++;
            gameState.streak++;
            
            document.getElementById('totalScore').textContent = gameState.score;
            document.getElementById('challengesCompleted').textContent = gameState.challengesCompleted;
            document.getElementById('currentStreak').textContent = gameState.streak;
            
            // Create flash overlay effect
            const flash = document.createElement('div');
            flash.className = 'success-flash';
            document.body.appendChild(flash);
            setTimeout(() => {
                if (document.body.contains(flash)) {
                    document.body.removeChild(flash);
                }
            }, 600);
            
            // Trigger celebration with sound and music
            showCelebration('ðŸŽ‰');
            createConfetti();
            playSound('celebration');
            playCelebrationMusic();
        }
        
        function showCelebration(emoji) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = emoji;
            document.body.appendChild(celebration);
            
            setTimeout(() => {
                if (document.body.contains(celebration)) {
                    document.body.removeChild(celebration);
                }
            }, 1500);
        }
        
        function showModal(title, message, buttonText = 'Got it! ðŸŽ®') {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'modal-content';
            
            const titleElement = document.createElement('h3');
            titleElement.textContent = title;
            
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            
            const button = document.createElement('button');
            button.className = 'modal-button';
            button.textContent = buttonText;
            button.onclick = () => {
                document.body.removeChild(overlay);
            };
            
            // Assemble modal
            modal.appendChild(titleElement);
            modal.appendChild(messageElement);
            modal.appendChild(button);
            overlay.appendChild(modal);
            
            // Add to page
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }
        
        function createConfetti() {
            const colors = ['#ff6b9d', '#c084fc', '#60a5fa', '#fcd34d', '#4ade80', '#f97316', '#ec4899'];
            const confettiCount = 100; // Double the confetti!
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // Start from random horizontal position
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-20px'; // Start from top
                    
                    // Random color
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    
                    // Varied animation speed
                    confetti.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                    
                    // Random size variation
                    const size = 10 + Math.random() * 10;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (document.body.contains(confetti)) {
                            document.body.removeChild(confetti);
                        }
                    }, 4000);
                }, i * 20);
            }
        }
        
        // Audio Effects System
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different sounds for different events
                switch(type) {
                    case 'success':
                        // Happy ascending chime
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'select':
                        // Quick click sound
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.05);
                        break;
                        
                    case 'start':
                        // Upbeat start sound
                        oscillator.frequency.setValueAtTime(392, audioContext.currentTime); // G4
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.15); // C5
                        oscillator.type = 'triangle';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.25);
                        break;
                        
                    case 'stop':
                        // Descending stop sound
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(392, audioContext.currentTime + 0.1); // G4
                        oscillator.type = 'triangle';
                        gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                        break;
                        
                    case 'error':
                        // Error buzz
                        oscillator.frequency.value = 200;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.15);
                        break;
                        
                    case 'celebration':
                        // Big celebration sound - multiple notes
                        const notes = [523.25, 659.25, 783.99, 1046.5]; // C5, E5, G5, C6
                        notes.forEach((freq, i) => {
                            const osc = audioContext.createOscillator();
                            const gain = audioContext.createGain();
                            osc.connect(gain);
                            gain.connect(audioContext.destination);
                            osc.frequency.value = freq;
                            osc.type = 'sine';
                            gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.08);
                            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.08 + 0.3);
                            osc.start(audioContext.currentTime + i * 0.08);
                            osc.stop(audioContext.currentTime + i * 0.08 + 0.3);
                        });
                        break;
                }
            } catch (e) {
                // Audio not supported, that's okay
                console.log('Audio not supported');
            }
        }
        
        function playSuccessSound() {
            playSound('success');
        }
        
        // Music System
        const musicState = {
            enabled: true,
            backgroundMusic: null,
            celebrationMusic: null,
            audioContext: null,
            backgroundGain: null,
            celebrationGain: null,
            backgroundPlaying: false
        };
        
        function initMusicSystem() {
            try {
                musicState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicState.backgroundGain = musicState.audioContext.createGain();
                musicState.celebrationGain = musicState.audioContext.createGain();
                musicState.backgroundGain.connect(musicState.audioContext.destination);
                musicState.celebrationGain.connect(musicState.audioContext.destination);
                musicState.backgroundGain.gain.value = 0.15; // Gentle background volume
                musicState.celebrationGain.gain.value = 0.3; // Louder celebration
            } catch (e) {
                console.log('Music system not available');
            }
        }
        
        function playBackgroundMusic() {
            if (!musicState.enabled || !musicState.audioContext || musicState.backgroundPlaying) return;
            
            try {
                musicState.backgroundPlaying = true;
                
                // Kids-friendly playful melody - "Twinkle Twinkle" inspired tune
                const melody = [
                    // "Twinkle twinkle" - familiar and comforting
                    { freq: 523.25, duration: 0.4 },  // C5
                    { freq: 523.25, duration: 0.4 },  // C5
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 880.00, duration: 0.4 },  // A5
                    { freq: 880.00, duration: 0.4 },  // A5
                    { freq: 783.99, duration: 0.8 },  // G5
                    
                    // "Little star"
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 587.33, duration: 0.4 },  // D5
                    { freq: 587.33, duration: 0.4 },  // D5
                    { freq: 523.25, duration: 0.8 },  // C5
                    
                    // "How I wonder"
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 587.33, duration: 0.8 },  // D5
                    
                    // "What you are"
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 783.99, duration: 0.4 },  // G5
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 698.46, duration: 0.4 },  // F5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 659.25, duration: 0.4 },  // E5
                    { freq: 587.33, duration: 0.8 }   // D5
                ];
                
                let currentTime = musicState.audioContext.currentTime;
                
                function playMelodyLoop() {
                    if (!musicState.backgroundPlaying) return;
                    
                    let cumulativeTime = 0;
                    melody.forEach((note) => {
                        const osc = musicState.audioContext.createOscillator();
                        osc.connect(musicState.backgroundGain);
                        osc.type = 'sine';
                        osc.frequency.value = note.freq;
                        
                        const noteStart = currentTime + cumulativeTime;
                        osc.start(noteStart);
                        osc.stop(noteStart + note.duration);
                        
                        cumulativeTime += note.duration;
                    });
                    
                    const pauseDuration = 1.5; // Pause between song repeats
                    const totalDuration = cumulativeTime + pauseDuration;
                    currentTime += totalDuration;
                    
                    // Schedule next loop
                    setTimeout(() => {
                        if (musicState.backgroundPlaying) {
                            currentTime = musicState.audioContext.currentTime;
                            playMelodyLoop();
                        }
                    }, totalDuration * 1000);
                }
                
                playMelodyLoop();
            } catch (e) {
                console.log('Could not play background music', e);
            }
        }
        
        function stopBackgroundMusic() {
            musicState.backgroundPlaying = false;
        }
        
        function playCelebrationMusic() {
            if (!musicState.enabled || !musicState.audioContext) return;
            
            try {
                // Play a triumphant fanfare
                const fanfare = [
                    { freq: 523.25, time: 0.0, duration: 0.2 },   // C5
                    { freq: 659.25, time: 0.2, duration: 0.2 },   // E5
                    { freq: 783.99, time: 0.4, duration: 0.3 },   // G5
                    { freq: 1046.50, time: 0.7, duration: 0.5 },  // C6
                    { freq: 783.99, time: 1.2, duration: 0.2 },   // G5
                    { freq: 1046.50, time: 1.4, duration: 0.6 }   // C6
                ];
                
                const startTime = musicState.audioContext.currentTime;
                
                fanfare.forEach(note => {
                    const osc = musicState.audioContext.createOscillator();
                    osc.connect(musicState.celebrationGain);
                    osc.type = 'triangle';
                    osc.frequency.value = note.freq;
                    osc.start(startTime + note.time);
                    osc.stop(startTime + note.time + note.duration);
                });
            } catch (e) {
                console.log('Could not play celebration music', e);
            }
        }
        
        function toggleMusic() {
            musicState.enabled = !musicState.enabled;
            const musicBtn = document.getElementById('musicToggle');
            
            if (musicState.enabled) {
                musicBtn.innerHTML = '<i class="fas fa-music"></i>';
                musicBtn.style.opacity = '1';
                // Resume background music if game is running
                if (gameState.isRunning) {
                    playBackgroundMusic();
                }
            } else {
                musicBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                musicBtn.style.opacity = '0.5';
                stopBackgroundMusic();
            }
            
            // Save preference
            localStorage.setItem('musicEnabled', musicState.enabled);
        }
        
        function initMusicToggle() {
            // Load saved preference
            const savedPref = localStorage.getItem('musicEnabled');
            if (savedPref !== null) {
                musicState.enabled = savedPref === 'true';
            }
            
            const musicBtn = document.getElementById('musicToggle');
            if (!musicState.enabled) {
                musicBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                musicBtn.style.opacity = '0.5';
            }
            
            musicBtn.addEventListener('click', toggleMusic);
        }
        
        function startGameTimer() {
            gameState.startTime = Date.now();
            gameState.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('gameTimer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopGameTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
        }
        
        // Settings modal functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        // Switch between settings tabs
        function switchSettingsTab(tabName) {
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active class to the selected tab and content
            event.target.closest('.settings-tab').classList.add('active');
            
            if (tabName === 'general') {
                document.getElementById('generalTabContent').classList.add('active');
            } else if (tabName === 'connection') {
                document.getElementById('connectionTabContent').classList.add('active');
            }
        }
        
        // Leaderboard modal functions
        function openLeaderboard() {
            document.getElementById('leaderboardModal').classList.add('active');
            displayLeaderboard(); // Refresh leaderboard when opening
        }
        
        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.remove('active');
        }
        
        // Game mode switching
        document.addEventListener('DOMContentLoaded', () => {
            // Settings toggle listener
            const settingsToggle = document.getElementById('settingsToggle');
            if (settingsToggle) {
                settingsToggle.addEventListener('click', openSettings);
            }
            
            // Difficulty selector listener
            const difficultySelect = document.getElementById('difficultySelect');
            if (difficultySelect) {
                difficultySelect.addEventListener('change', (e) => {
                    gameState.difficulty = e.target.value;
                    console.log('ðŸŽšï¸ Difficulty changed to:', gameState.difficulty);
                });
            }
            
            // Close settings modal on overlay click
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        closeSettings();
                    }
                });
            }
            
            // Close leaderboard modal on overlay click
            const leaderboardModal = document.getElementById('leaderboardModal');
            if (leaderboardModal) {
                leaderboardModal.addEventListener('click', (e) => {
                    if (e.target === leaderboardModal) {
                        closeLeaderboard();
                    }
                });
            }
            
            // Mode button listeners
            const modeButtons = document.querySelectorAll('.mode-btn');
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Play selection sound
                    playSound('select');
                    
                    // Remove active from all
                    modeButtons.forEach(b => b.classList.remove('active'));
                    // Add active to clicked
                    btn.classList.add('active');
                    // Update mode
                    gameState.currentMode = btn.dataset.mode;
                    // Clear completed challenges when switching modes
                    gameState.completedChallenges.clear();
                    // Generate new challenges
                    generateNewChallenges();
                });
            });
            
            // Initialize with default challenges
            generateNewChallenges();
        });
        
        // Smart API endpoint detection for RHAIIS/vLLM
        function getDefaultAPIEndpoint() {
            // Use external route endpoint
            return "https://rhaiis-route-rhaiis.apps.cluster-pjc5d.pjc5d.sandbox1225.opentlc.com";
        }
        
        // Initialize endpoints with default external route
        const defaultEndpoint = getDefaultAPIEndpoint();
        const baseURLInput = document.getElementById('baseURL');
        if (baseURLInput) {
            baseURLInput.value = defaultEndpoint;
        }

        let stream;
        let intervalId;
        let isProcessing = false;
        let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back camera

        // Handle vLLM endpoint dropdown change
        function handleVllmEndpointChange() {
            const select = document.getElementById('vllmEndpointSelect');
            const customWrapper = document.getElementById('customVllmEndpointWrapper');
            const baseURLInput = document.getElementById('baseURL');
            
            if (select.value === 'custom') {
                customWrapper.style.display = 'block';
                baseURLInput.focus();
            } else {
                customWrapper.style.display = 'none';
                baseURLInput.value = select.value;
                
                // Update status message
                if (stream) {
                    updateStatus('ready', 'Camera ready - Using external route', 'check-circle');
                    responseText.value = `Camera access granted. Using external route.\nReady to start processing with VLM.`;
                }
            }
        }

        // Fetch available models from the custom endpoint
        async function fetchAvailableModels() {
            const baseURLInput = document.getElementById('baseURL');
            const modelSelect = document.getElementById('modelSelect');
            const fetchBtn = document.getElementById('fetchModelsBtn');
            
            const endpoint = baseURLInput.value.trim();
            
            if (!endpoint) {
                alert('Please enter a custom endpoint URL first');
                baseURLInput.focus();
                return;
            }
            
            // Show loading state
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Fetching models...</span>';
            modelSelect.disabled = true;
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                // Build the models API URL
                const modelsUrl = `${endpoint}/v1/models`;
                
                // Use the same headers as API requests (includes API key if provided)
                const headers = getApiHeaders();
                
                console.log('Fetching models from:', modelsUrl);
                
                const response = await fetch(modelsUrl, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    signal: controller.signal,
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Models response:', data);
                    
                    // Extract model IDs from the response
                    const models = data.data || data.models || [];
                    
                    if (models.length === 0) {
                        modelSelect.innerHTML = '<option value="">No models found</option>';
                        alert('No models found at this endpoint');
                    } else {
                        modelSelect.innerHTML = '<option value="">Select a model</option>';
                        models.forEach(model => {
                            const option = document.createElement('option');
                            const modelId = model.id || model.name || model;
                            option.value = modelId;
                            option.textContent = modelId;
                            modelSelect.appendChild(option);
                        });
                        modelSelect.disabled = false;
                        
                        // Show success message
                        updateStatus('ready', `Found ${models.length} models`, 'check-circle');
                        responseText.value = `âœ… Successfully fetched ${models.length} models from endpoint.\n\nPlease select a model from the dropdown.`;
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error fetching models:', response.status, errorText);
                    modelSelect.innerHTML = '<option value="">Error fetching models</option>';
                    alert(`Failed to fetch models: ${response.status} ${response.statusText}\n\n${errorText}`);
                }
            } catch (error) {
                console.error('Error fetching models:', error);
                modelSelect.innerHTML = '<option value="">Error - fetch models again</option>';
                
                if (error.name === 'AbortError') {
                    alert('Request timed out after 10 seconds. Please check your endpoint URL.');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    alert('CORS or connection error. Make sure the endpoint allows cross-origin requests.\n\nError: ' + error.message);
                } else {
                    alert('Error fetching models: ' + error.message);
                }
            } finally {
                // Restore button state
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-download"></i><span>Fetch Available Models</span>';
            }
        }

        // Get the selected model name
        function getSelectedModel() {
            const select = document.getElementById('vllmEndpointSelect');
            const modelSelect = document.getElementById('modelSelect');
            
            // If using custom endpoint and a model is selected, use it
            if (select.value === 'custom' && modelSelect.value) {
                return modelSelect.value;
            }
            
            // Otherwise use the default model
            return "Qwen/Qwen2-VL-2B-Instruct";
        }

        // Get API headers
        function getApiHeaders() {
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };
            
            // Add API key if provided (for custom endpoints)
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput && apiKeyInput.value.trim()) {
                headers['Authorization'] = `Bearer ${apiKeyInput.value.trim()}`;
            }
            
            return headers;
        }

        // Test connection function for vLLM API
        async function testConnection() {
            const endpoint = baseURL.value.trim();
            
            updateStatus('processing', 'Testing vLLM connection...', 'wifi');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                console.log('Testing vLLM connection to:', baseURL.value || 'internal service');
                
                // Get the selected model
                const selectedModel = getSelectedModel();
                console.log('Using model:', selectedModel);
                
                // Test the vLLM API endpoint with a simple chat completion request
                const testPayload = {
                    model: selectedModel,
                    max_tokens: 20,
                    messages: [
                        { role: "user", content: "Hello, can you respond?" }
                    ]
                };

                // Build API URL - append /v1/chat/completions to the service URL
                const apiUrl = baseURL.value.trim() ? `${baseURL.value}/v1/chat/completions` : '/v1/chat/completions';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    mode: 'cors',
                    signal: controller.signal,
                    body: JSON.stringify(testPayload)
                });

                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('ready', 'vLLM connection successful', 'check-circle');
                    const serverInfo = baseURL.value.trim() || 'internal service';
                    const message = `RHAIIS vLLM connection successful!\n\nEndpoint: ${serverInfo}\nModel: ${selectedModel}\nTest Response: ${data.choices?.[0]?.message?.content || 'API responded correctly'}`;
                    showModal('âœ… Connection Successful', message, 'Great! ðŸŽ®');
                } else {
                    const errorText = await response.text();
                    updateStatus('ready', 'Server reachable but API error', 'exclamation-triangle');
                    const serverInfo = baseURL.value.trim() || 'internal service';
                    const message = `vLLM server reachable but API returned error: ${response.status}\n\nEndpoint: ${serverInfo}\nError: ${errorText}`;
                    showModal('âš ï¸ Connection Warning', message, 'Got it');
                }
            } catch (error) {
                console.error('vLLM connection test error:', error);
                updateStatus('error', 'vLLM connection failed', 'exclamation-triangle');
                
                const serverInfo = baseURL.value.trim() || 'internal service';
                let message = '';
                if (error.name === 'AbortError') {
                    message = `vLLM connection test timed out after 15 seconds.\n\nEndpoint: ${serverInfo}\n\nPlease check:\n1. Is the RHAIIS vLLM server running?\n2. Is the URL correct?\n3. Are you experiencing network issues?`;
                } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    message = `CORS or connection error.\n\nEndpoint: ${serverInfo}\n\nFor vLLM servers:\n1. Make sure server started with --host 0.0.0.0\n2. Check if CORS is properly configured\n\nError: ${error.message}`;
                } else {
                    message = `Connection error: ${error.message}\n\nEndpoint: ${serverInfo}`;
                }
                showModal('âŒ Connection Failed', message, 'Try Again');
            }
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        // Status indicator management
        function updateStatus(type, message, icon = 'circle') {
            statusIndicator.className = `status-indicator status-${type}`;
            statusIndicator.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
            
            if (type === 'processing') {
                statusIndicator.classList.add('pulse');
            } else {
                statusIndicator.classList.remove('pulse');
            }
        }

        // Send chat completion request to vLLM API
        async function sendChatCompletionRequest(instruction, imageBase64URL) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            try {
                // Build API URL - append /v1/chat/completions to the service URL
                const apiUrl = baseURL.value.trim() ? `${baseURL.value}/v1/chat/completions` : '/v1/chat/completions';
                console.log('Sending request to:', apiUrl);
                
                // Get the selected model
                const selectedModel = getSelectedModel();
                console.log('Using model:', selectedModel);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    mode: 'cors', // Explicitly set CORS mode
                    signal: controller.signal,
                    body: JSON.stringify({
                        model: selectedModel,
                        max_tokens: 100,  // Increased for explanation
                        temperature: 0,  // Zero temperature for maximum determinism - crucial for YES/NO responses
                        messages: [
                            { role: 'user', content: [
                                { type: 'text', text: instruction },
                                { type: 'image_url', image_url: {
                                    url: imageBase64URL,
                                } }
                            ] },
                        ]
                    })
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Server error response:', response.status, errorData);
                    return `Server error: ${response.status} - ${errorData}`;
                }
                
                const data = await response.json();
                console.log('Successful response received');
                return data.choices[0].message.content;
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('Fetch error details:', error);
                
                if (error.name === 'AbortError') {
                    return 'Request timed out after 30 seconds. Please check your API endpoint and network connection.';
                } else if (error.message.includes('Failed to fetch')) {
                    return `Failed to connect to API endpoint. Please check:\n1. Is the vLLM/API server running?\n2. Is the endpoint URL correct? (vLLM typically uses port 8000)\n3. For OpenShift: Is the service route configured correctly?\n4. Are you experiencing network issues?\n5. Does the server support CORS?\n\nEndpoint: ${baseURL.value || 'proxy endpoint'}\nError: ${error.message}`;
                } else {
                    return `Network error: ${error.message}`;
                }
            }
        }

        // Camera initialization
        async function initCamera() {
            try {
                updateStatus('processing', 'Requesting camera access...', 'camera');
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode }, 
                    audio: false 
                });
                video.srcObject = stream;
                
                // Check if API endpoint is set
                if (!baseURL.value.trim()) {
                    updateStatus('ready', 'Camera ready - Using proxy endpoint', 'check-circle');
                    responseText.value = "Camera access granted. Using proxy endpoint for API calls. Ready to start processing.";
                } else {
                    updateStatus('ready', 'Camera ready - Click start to begin', 'check-circle');
                    responseText.value = "Camera access granted. Ready to start processing.";
                }
            } catch (err) {
                console.error("Error accessing camera:", err);
                updateStatus('error', 'Camera access denied', 'exclamation-triangle');
                responseText.value = `Error accessing camera: ${err.name} - ${err.message}. Please ensure permissions are granted and you are on HTTPS or localhost.`;
                
                // Show user-friendly error message
                if (err.name === 'NotAllowedError') {
                    responseText.value = "Camera access was denied. Please allow camera permissions and refresh the page.";
                } else if (err.name === 'NotFoundError') {
                    responseText.value = "No camera found. Please connect a camera and refresh the page.";
                } else {
                    responseText.value = `Camera error: ${err.message}. Please check your camera and try again.`;
                }
            }
        }

        // Switch between front and back camera
        async function switchCamera() {
            try {
                // Toggle facing mode
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                
                // Stop current stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Show loading state
                updateStatus('processing', `Switching to ${currentFacingMode === 'user' ? 'front' : 'back'} camera...`, 'camera');
                
                // Initialize camera with new facing mode
                await initCamera();
                
                console.log(`Switched to ${currentFacingMode === 'user' ? 'front' : 'back'} camera`);
            } catch (err) {
                console.error("Error switching camera:", err);
                updateStatus('error', 'Failed to switch camera', 'exclamation-triangle');
                responseText.value = `Error switching camera: ${err.message}. Trying to restore previous camera...`;
                
                // Try to restore previous camera
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                try {
                    await initCamera();
                } catch (restoreErr) {
                    responseText.value = `Failed to restore camera: ${restoreErr.message}. Please refresh the page.`;
                }
            }
        }

        function captureImage() {
            if (!stream || !video.videoWidth) {
                console.warn("Video stream not ready for capture.");
                return null;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8); // Use JPEG for smaller size, 0.8 quality
        }

        async function sendData() {
            if (!isProcessing) return;

            const instruction = instructionText.value;
            const imageBase64URL = captureImage();

            if (!imageBase64URL) {
                updateStatus('error', 'Failed to capture image', 'exclamation-triangle');
                responseText.value = "Failed to capture image. Stream might not be active.";
                return;
            }

            try {
                updateStatus('processing', 'Processing with AI...', 'brain');
                console.log('ðŸ“¤ Sending instruction to AI:', instruction);
                const response = await sendChatCompletionRequest(instruction, imageBase64URL);
                console.log('ðŸ“¥ AI Response:', response);
                responseText.value = response;
                
                // Check if we have an active challenge and the AI said yes
                if (gameState.currentChallenge) {
                    const normalizedResponse = response.toLowerCase().trim();
                    const mode = gameState.currentMode;
                    const challengeText = gameState.currentChallenge.text.toLowerCase();
                    
                    // Determine if this is an open-ended question or YES/NO
                    const isOpenEnded = 
                        challengeText.includes('what colors');
                    
                    let isSuccess = false;
                    
                    if (!isOpenEnded) {
                        // For YES/NO questions - Check for explicit YES or positive descriptions
                        // Primary check: Look for YES at the start
                        isSuccess = normalizedResponse.match(/^yes\b/i) || // Starts with YES
                                   normalizedResponse.match(/^yes\s*-/i) || // YES - format
                                   normalizedResponse.match(/^yes\s*,/i); // YES, format
                        
                        // Fallback: If AI describes seeing the item but didn't say YES, infer success
                        if (!isSuccess && normalizedResponse.length < 100) {
                            // Check for positive affirmative patterns
                            const affirmativePatterns = [
                                /\b(i see|i can see|there is|there are|i do see|i spot)\b/i,
                                /\b(holding|showing|displaying|presenting|has)\s+(?:a|an|the)?\s*\w+/i,
                                /\b(visible|present|appears|looks like)\b/i,
                                /person\s+(?:is|with|holding|has)/i,
                                /\b(?:is|are)\s+(?:a|an|some|the)?\s*\w+(?:\s+\w+)?\s+(?:in|on|visible)/i
                            ];
                            
                            for (const pattern of affirmativePatterns) {
                                if (normalizedResponse.match(pattern)) {
                                    isSuccess = true;
                                    console.log('âœ… Inferred YES from description:', normalizedResponse);
                                    break;
                                }
                            }
                        }
                        
                        // Double-check: If response contains "no" or "not" or "don't", it's definitely NO
                        if (normalizedResponse.match(/\b(no|not|don't|cannot|can't|do not)\b/i)) {
                            isSuccess = false;
                            console.log('âŒ Found negative keywords, overriding to NO');
                        }
                        
                        console.log('ðŸ” Response validation:', {
                            response: normalizedResponse,
                            isSuccess: isSuccess,
                            reason: isSuccess ? 'Affirmative detected' : 'No affirmative found (default: NO)'
                        });
                    }
                    
                    if (isSuccess) {
                        // Check if enough time has passed since challenge was selected (prevent instant wins)
                        const timeSinceStart = Date.now() - (gameState.challengeStartTime || 0);
                        if (timeSinceStart < gameState.minChallengeDuration) {
                            console.log(`â° Challenge too fast! ${timeSinceStart}ms elapsed, need ${gameState.minChallengeDuration}ms`);
                            responseText.value = `ðŸŽ¯ Getting ready...\n\nShow me what you've got! Keep trying!`;
                            updateStatus('ready', 'ðŸŽ¯ Show me the challenge!', 'play-circle');
                            return; // Don't award points yet
                        }
                        
                        // Award points!
                        const points = gameState.currentChallenge.points;
                        updateScore(points);
                        
                        // Show success message with AI's explanation
                        responseText.value = `âœ… AI SAYS YES!\n\n${response}\n\nðŸŽ‰ AWESOME! You earned ${points} points!\n\nPick another challenge to continue!`;
                        
                        // Clear the active challenge
                        document.querySelectorAll('.challenge-card').forEach(c => c.classList.remove('active'));
                        gameState.currentChallenge = null;
                gameState.challengeStartTime = null; // Reset timer
                        
                        // Hide and reset manual button
                        const manualBtn = document.getElementById('manualCompleteBtn');
                        manualBtn.style.display = 'none';
                        manualBtn.style.animation = '';
                        
                        // Update status
                        updateStatus('ready', 'ðŸŽ‰ Challenge complete! Pick another!', 'star');
                    } else {
                        // For open-ended questions or if not successful
                        if (isOpenEnded) {
                            responseText.value = `ðŸ“ AI's Answer:\n\n${response}\n\nðŸ‘€ Check if this is correct! If yes, click the green âœ… button below to award points.`;
                            updateStatus('ready', 'ðŸ‘€ Check the AI\'s answer! Click âœ… button if correct.', 'play-circle');
                        } else {
                            responseText.value = `âŒ AI SAYS NO\n\n${response}\n\nðŸ” Keep trying! Show the item/action to the camera.`;
                            updateStatus('ready', 'ðŸ” Keep trying!', 'play-circle');
                        }
                    }
                } else {
                updateStatus('ready', 'Processing active', 'play-circle');
                }
            } catch (error) {
                console.error('Error sending data:', error);
                updateStatus('error', 'API request failed', 'exclamation-triangle');
                responseText.value = `Error: ${error.message}`;
            }
        }

        function handleStart() {
            if (!stream) {
                updateStatus('error', 'Camera not available', 'exclamation-triangle');
                responseText.value = "Camera not available. Please grant permission first.";
                return;
            }
            
            // Check if a challenge is selected
            if (!gameState.currentChallenge) {
                showChallengePrompt();
                return;
            }
            
            // Allow empty endpoint for OpenShift proxy setup
            const endpoint = baseURL.value.trim();
            if (!endpoint) {
                console.log('Using proxy endpoint (empty baseURL)');
            }
            
            // Clear any pending leaderboard data from previous game
            pendingLeaderboardData = null;

            isProcessing = true;
            
            // Play game start sound
            playSound('start');
            
            // Start background music
            playBackgroundMusic();
            
            // Start game timer
            startGameTimer();
            
            // Update button appearance
            startButton.innerHTML = '<i class="fas fa-stop"></i><span>Stop Game</span>';
            startButton.classList.remove('btn-primary');
            startButton.classList.add('btn-danger');

            // Disable controls (except instructionText - keep it editable for on-the-fly prompt tuning!)
            // instructionText.disabled = true;  // Keeping this editable!
            modelSelect.disabled = true;
            intervalSelect.disabled = true;
            baseURL.disabled = true;

            updateStatus('processing', 'ðŸŽ® Game started! Have fun!', 'play-circle');
            responseText.value = "ðŸŽ® Let's play! Pick a challenge and show me! ðŸŽ‰";

            const intervalMs = parseInt(intervalSelect.value, 10);
            
            // Initial immediate call
            sendData(); 
            
            // Then set interval
            intervalId = setInterval(sendData, intervalMs);
        }

        function handleStop() {
            isProcessing = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            // Play stop sound
            playSound('stop');
            
            // Stop background music
            stopBackgroundMusic();
            
            // Stop game timer
            stopGameTimer();
            
            // Calculate elapsed time
            const elapsedSeconds = gameState.startTime ? Math.floor((Date.now() - gameState.startTime) / 1000) : 0;
            const timeString = formatTime(elapsedSeconds);
            
            // Save current score before resetting
            const finalScore = gameState.score;
            const finalChallenges = gameState.challengesCompleted;
            const finalStreak = gameState.streak;
            
            // Update button appearance
            startButton.innerHTML = '<i class="fas fa-play"></i><span>Start Game</span>';
            startButton.classList.remove('btn-danger');
            startButton.classList.add('btn-primary');

            // Enable controls
            instructionText.disabled = false;
            modelSelect.disabled = false;
            intervalSelect.disabled = false;
            baseURL.disabled = false;

            updateStatus('ready', 'ðŸŽ¯ Ready for next round!', 'check-circle');
            
            // Reset game state for next round
            gameState.score = 0;
            gameState.challengesCompleted = 0;
            gameState.streak = 0;
            gameState.completedChallenges.clear();
            gameState.currentChallenge = null;
            
            // Update display
            document.getElementById('totalScore').textContent = '0';
            document.getElementById('challengesCompleted').textContent = '0';
            document.getElementById('currentStreak').textContent = '0';
            
            // Generate fresh challenges
            generateNewChallenges();
            
            // If player scored points, show cartoon modal for name input
            if (finalScore > 0) {
                showNameModal(finalScore, finalChallenges, finalStreak, timeString);
            } else {
                responseText.value = "Ready to play! Pick a challenge and click Start! ðŸŽ®";
            }
        }

        // Event listeners
        startButton.addEventListener('click', () => {
            if (isProcessing) {
                handleStop();
            } else {
                handleStart();
            }
        });

        themeToggle.addEventListener('click', toggleTheme);

        // Add fade-in animation to cards
        function addFadeInAnimation() {
            const cards = document.querySelectorAll('.video-section, .controls-section, .input-card, .header');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        }

        // Initialize everything when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initCamera();
            initMusicSystem();
            initMusicToggle();
            addFadeInAnimation();
            // Initialize model selection visibility based on default endpoint
            updateModelSelectionVisibility(baseURL.value);
            // Initialize leaderboard display
            displayLeaderboard();
        });

        // Cleanup when page is closed/navigated away
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (intervalId) {
                clearInterval(intervalId);
            }
            stopBackgroundMusic();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Close leaderboard modal with ESC
            const leaderboardModal = document.getElementById('leaderboardModal');
            if (leaderboardModal && leaderboardModal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeLeaderboard();
                    return;
                }
            }
            
            // Close settings modal with ESC
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal && settingsModal.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeSettings();
                    return;
                }
            }
            
            // Close challenge prompt modal with ESC or Enter
            const challengeModal = document.getElementById('challengePromptModal');
            if (challengeModal && challengeModal.style.display === 'flex') {
                if (e.key === 'Escape' || e.key === 'Enter') {
                    closeChallengePrompt();
                    return;
                }
            }
            
            if (e.key === ' ' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                if (isProcessing) {
                    handleStop();
                } else {
                    handleStart();
                }
            }
            if (e.key === 'Escape' && isProcessing) {
                handleStop();
            }
        });

    </script>
</body>
</html>

